---
title: "Eye size and allometry in deep-sea sergestids"
author: "Katie Thomas"
date: "September 2020"
output:
  html_document:
    code_fold: hide
    theme: flatly
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

<style type="text/css">

body{ /* Normal  */
      font-size: 17px;
  }
  
</style>

```{r setup, include=FALSE}

#set rmarkdown options
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 8, attr.output='style="max-height: 300px;"') 

#load libraries
library(cowplot)
library(plyr)
library(knitr)
library(kableExtra)
library(gridExtra)
library(evobiR)
library(geiger)
library(phylotools)
library(ape)
library(caper)
library(phytools)
library(smatr)
library(tidyverse)
library(plotly)
```

# Data

## Morphological data

Morphological measurements (eye diameter and body length) were taken from a mixture of fresh and preserved specimens. In total, 454 sergestid specimens were sampled from 15 species belonging to 11 genera and two subgroups (Sergestes and Sergia).

```{r import-data}

# Full specimen morphology dataset  ------

#import data
specimens_raw <- data.frame(read.csv("../Data/specimen_data.csv", header=TRUE, na.strings=c("", "NA", " ", stringsAsFactors = FALSE)))

#tidy data
specimens <- specimens_raw %>%
  mutate(Genus = gsub('\\s+', '', Genus)) %>%
  mutate(Family = str_to_title(Family)) %>%
  mutate(Subgroup = str_to_title(Subgroup)) %>%
  mutate(Genus = str_to_title(Genus)) %>%
  mutate(genus_species = as.factor(paste(Genus, Species, sep = "_"))) %>%
  mutate(pres_bin = recode_factor(Preservation, "ethanol" = "preserved", "paraformaldehyde" = "preserved", "fresh" = "fresh"))


# Species traits  ------

#import data
traits_raw <- data.frame(read.csv("../Data/species_data.csv", header=TRUE, na.strings=c("", "NA", " ", stringsAsFactors = FALSE)))

#tidy data
traits <- traits_raw %>%
  mutate(Genus = gsub('\\s+', '', Genus)) %>%
  mutate(genus_species = as.factor(paste(Genus, Species, sep = "_"))) 

# Show sampling -----

#compile number of shrimp sampled by species
counts <-ddply(specimens, .(specimens$Subgroup, specimens$Genus, specimens$Species), nrow) 

#create table column names
names(counts) <- c("Subgroup", "Genus","Species","Sampled") 

#generate scrolling table in RMarkdown
kable(counts[ , c("Subgroup", "Genus","Species","Sampled")], caption = "Species and sampling effort for morphological data from family Sergestidae.") %>% 
                      kable_styling(full_width = F) %>% 
                      collapse_rows(columns = 1, valign = "top") %>%
                      scroll_box(height = "400px") 
```


## Molecular phylogeny

Below is the sergestid molecular phylogeny generated by Charles Golightly that we have pruned to the 15 species in the dataset for comparative analyses.

```{r import-phylo, results = "hide"}

#Import phylogeny
tree_orig <- read.tree(file = "../Data/sertestid_tree_rooted")

#Make copy of tree to manipulate
tree_edit <- tree_orig

#Remove locality tags from phylo tip labels 
n <- 3 #which _ to end pattern at
pat <- paste0('^([^_]+(?:_[^_]+){',n-1,'}).*') #pattern
tree_edit$tip.label <- sub(pat, '\\1', tree_edit$tip.label) #remove tags from tips

#Make list of taxa to drop (in tree but not in dataset)
drops <- setdiff(tree_edit$tip.label, as.character(traits$Binomial))

#Drop unwanted tips from phylogeny
tree.pruned <- drop.tip(phy = tree_edit, tip = drops) 

#Check and reorder tree
is.rooted(tree.pruned) 
is.binary.tree(tree.pruned) 
tree <- ladderize(tree.pruned) 

#Make row names of the species the phylogeny tip labels
rownames(traits) <- traits$Binomial

#Reorder species data to match phylogeny order
traits <-ReorderData(tree, traits, taxa.names="row names")

#check that phylogeny tips and data match exactly (if they match will return "OK")
name.check(tree, traits)

#make tree ultrametric
tree <- chronopl(tree, 1)
```

```{r plot-phylo, fig.height=5, fig.width=5}

#plot tree of sampled species with original tip labels
plot.phylo(tree, #phylogeny to plot
           type = "phylogram", #how to visualize phylogeny
           show.tip.label = TRUE, #whether to show tip labels/species names
           cex = 1.0, #text size
           no.margin = TRUE, 
           use.edge.length = TRUE,
           edge.width = 2, #thickness of phylogeny branches
           label.offset = 0.1) #how far away from tips to put labels
```


# Ontogenetic eye-body allometry in Sergestidae

## Eye-body allometry in each species

We first examine ontogenetic eye diameter-body length allometry across 14 species of deep-sea sergestids. Allometric relationships were fit using standardised major axis regression via the _smatr_ v.3.4.8 package. For each species, standard model checks, model fits, and an interactive plot of data and fits are shown. Hover over the plots to see individual data values (this is super helpful for checking weird outliers that may be typos in the source datasheets).

Note that for 3 of the species, a large/unreasonable outlier was present. We identified these by eye and they have been removed from the data subsets and analyses, but the outlier value is noted under each species header for reference, and a second plot including the outlier as a red diamond is included for transparency (these can go into the supplemental information if we want). 

```{r pres-cols}
#set colors for fresh and preserved samples
col_pres <- c("ethanol" = "#a6cee3",
              "fresh" = "#b2df8a",
              "paraformaldehyde" = "#1f78b4")
```

### _Allosergestes pectinatus_

```{r dev-apec}

# Subset data -----
apec <- specimens %>% filter(genus_species == "Allosergestes_pectinatus")

# Fit SMA model ------
sma_apec <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = apec, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_apec, which = "default",type = "o") 
plot(sma_apec, which = "residual",type = "o")
plot(sma_apec, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_apec)

#save coefficients of fits as object
cc_sma_apec <- data.frame(coef(sma_apec))

# Make plot ------
plot_apec <- ggplot(apec, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Allosergestes pectinatus") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_apec, aes(intercept = cc_sma_apec[1,1], slope = cc_sma_apec[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_apec[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_apec[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_apec)
```

### _Allosergestes sargassi_

Note: this species has a big outlier that was removed for analyses and plots (eye 0.67, body 12.97). 

```{r dev-asar}

# Subset data -----
#note: outlier removed
asar <- specimens %>% 
  filter(genus_species == "Allosergestes_sargassi") %>%
  filter(!(Eye_Diameter == 0.67 & Body_Length == 12.97))

# Fit SMA model ------
sma_asar <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = asar, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_asar, which = "default",type = "o") 
plot(sma_asar, which = "residual",type = "o")
plot(sma_asar, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_asar)

#save coefficients of fits as object
cc_sma_asar <- data.frame(coef(sma_asar))

# Make plot ------
plot_asar <- ggplot(asar, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Allosergestes sargassi") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_asar, aes(intercept = cc_sma_asar[1,1], slope = cc_sma_asar[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_asar[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_asar[1,1], digits = 2), sep = " "), size = 3, col = "black")

#plot with outlier shown
plot_asar_out <- plot_asar +
  geom_point(aes(y=0.67, x=12.97), colour="red", pch = 18) +
  ggtitle("Allosergestes sargassi + outlier")
  
#plot
ggplotly(plot_asar)

#plot with outlier
ggplotly(plot_asar_out)
```

### _Challengerosergia hansjacobi_

```{r dev-chan}

# Subset data -----
chan <- specimens %>% filter(genus_species == "Challengerosergia_hansjacobi")

# Fit SMA model ------
sma_chan <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = chan, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_chan, which = "default",type = "o") 
plot(sma_chan, which = "residual",type = "o")
plot(sma_chan, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_chan)

#save coefficients of fits as object
cc_sma_chan <- data.frame(coef(sma_chan))

# Make plot ------
plot_chan <- ggplot(chan, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Challengerosergia hansjacobi") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_chan, aes(intercept = cc_sma_chan[1,1], slope = cc_sma_chan[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_chan[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_chan[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_chan)
```

### _Challengerosergia talismani_

```{r dev-ctal}

# Subset data -----
ctal <- specimens %>% filter(genus_species == "Challengerosergia_talismani")

# Fit SMA model ------
sma_ctal <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = ctal, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_ctal, which = "default",type = "o") 
plot(sma_ctal, which = "residual",type = "o")
plot(sma_ctal, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_ctal)

#save coefficients of fits as object
cc_sma_ctal <- data.frame(coef(sma_ctal))

# Make plot ------
plot_ctal <- ggplot(ctal, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Challengerosergia talismani") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_ctal, aes(intercept = cc_sma_ctal[1,1], slope = cc_sma_ctal[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_ctal[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_ctal[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_ctal)
```

### _Deosergestes corniculum_

```{r dev-dcor}

# Subset data -----
dcor <- specimens %>% filter(genus_species == "Deosergestes_corniculum")

# Fit SMA model ------
sma_dcor <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = dcor, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_dcor, which = "default",type = "o") 
plot(sma_dcor, which = "residual",type = "o")
plot(sma_dcor, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_dcor)

#save coefficients of fits as object
cc_sma_dcor <- data.frame(coef(sma_dcor))

# Make plot ------
plot_dcor <- ggplot(dcor, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Deosergestes corniculum") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_dcor, aes(intercept = cc_sma_dcor[1,1], slope = cc_sma_dcor[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_dcor[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_dcor[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_dcor)
```

### _Deosergestes henseni_

**Note: There is a data point for this species (eye 0.67, body 12.97) that is identical to one of the outliers I identified for _Allosergestes sargassi_. Seems unlikely to have two identical specimens for both eye diameter and body length to the 0.01 measurement, so have flagged to check in original data. This datapoint looks like sort of an outlier in this species as well, see interactive plot**

```{r dev-dhen}

# Subset data -----
dhen <- specimens %>% filter(genus_species == "Deosergestes_henseni")

# Fit SMA model ------
sma_dhen <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = dhen, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_dhen, which = "default",type = "o") 
plot(sma_dhen, which = "residual",type = "o")
plot(sma_dhen, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_dhen)

#save coefficients of fits as object
cc_sma_dhen <- data.frame(coef(sma_dhen))

# Make plot ------
plot_dhen <- ggplot(dhen, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Deosergestes henseni") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_dhen, aes(intercept = cc_sma_dhen[1,1], slope = cc_sma_dhen[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_dhen[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_dhen[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_dhen)
```

### _Gardinerosergia splendens_

Note: this species has a big outlier that was removed for analyses and plots (eye 1.71, body 21.98). 

```{r dev-gspl}

# Subset data -----
gspl <- specimens %>% 
  filter(genus_species == "Gardinerosergia_splendens") %>%
  filter(!(Eye_Diameter == 1.71 & Body_Length == 21.98))

# Fit SMA model ------
sma_gspl <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = gspl, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_gspl, which = "default",type = "o") 
plot(sma_gspl, which = "residual",type = "o")
plot(sma_gspl, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_gspl)

#save coefficients of fits as object
cc_sma_gspl <- data.frame(coef(sma_gspl))

# Make plot ------
plot_gspl <- ggplot(gspl, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Gardinerosergia splendens") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_gspl, aes(intercept = cc_sma_gspl[1,1], slope = cc_sma_gspl[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_gspl[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_gspl[1,1], digits = 2), sep = " "), size = 3, col = "black")

#plot with outlier shown
plot_gspl_out <- plot_gspl +
  geom_point(aes(y=1.71, x=21.98), colour="red", pch = 18) +
  ggtitle("Gardinerosergia splendens + outlier")
  
#plot
ggplotly(plot_gspl)

#plot with outlier
ggplotly(plot_gspl_out)
```

### _Neosergestes edwardsii_

Note: this species has a big outlier that was removed for analyses and plots (eye 0.85, body 0.72). Also note that for this species, sample size was insufficient to estimate eye-body allometry (N = 6, p = 0.42 for correlation between eye size and body size). 

```{r dev-nedw}

# Subset data -----
nedw <- specimens %>% 
  filter(genus_species == "Neosergestes_edwardsii") %>%
  filter(!(Eye_Diameter == 0.85 & Body_Length == 0.72))

# Fit SMA model ------
sma_nedw <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = nedw, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_nedw, which = "default",type = "o") 
plot(sma_nedw, which = "residual",type = "o")
plot(sma_nedw, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_nedw)

#save coefficients of fits as object
cc_sma_nedw <- data.frame(coef(sma_nedw))

# Make plot ------
plot_nedw <- ggplot(nedw, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Neosergestes edwardsii") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) 

#plot with outlier shown
plot_nedw_out <- plot_nedw +
  geom_point(aes(x=0.85, y=0.72), colour="red", pch = 18) +
  ggtitle("Neosergestes edwardsii + outlier")
  
#plot
ggplotly(plot_nedw)

#plot with outlier
ggplotly(plot_nedw_out)
```

### _Parasergestes armatus_

```{r dev-parm}

# Subset data -----
parm <- specimens %>% filter(genus_species == "Parasergestes_armatus")

# Fit SMA model ------
sma_parm <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = parm, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_parm, which = "default",type = "o") 
plot(sma_parm, which = "residual",type = "o")
plot(sma_parm, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_parm)

#save coefficients of fits as object
cc_sma_parm <- data.frame(coef(sma_parm))

# Make plot ------
plot_parm <- ggplot(parm, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Parasergestes armatus") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_parm, aes(intercept = cc_sma_parm[1,1], slope = cc_sma_parm[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_parm[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_parm[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_parm)
```

### _Parasergestes vigilax_

```{r dev-pvig}

# Subset data -----
pvig <- specimens %>% filter(genus_species == "Parasergestes_vigilax")

# Fit SMA model ------
sma_pvig <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = pvig, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_pvig, which = "default",type = "o") 
plot(sma_pvig, which = "residual",type = "o")
plot(sma_pvig, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_pvig)

#save coefficients of fits as object
cc_sma_pvig <- data.frame(coef(sma_pvig))

# Make plot ------
plot_pvig <- ggplot(pvig, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Parasergestes vigilax") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_pvig, aes(intercept = cc_sma_pvig[1,1], slope = cc_sma_pvig[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_pvig[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_pvig[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_pvig)
```

### _Phorcosergia grandis_

```{r dev-pgra}

# Subset data -----
pgra <- specimens %>% filter(genus_species == "Phorcosergia_grandis")

# Fit SMA model ------
sma_pgra <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = pgra, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_pgra, which = "default",type = "o") 
plot(sma_pgra, which = "residual",type = "o")
plot(sma_pgra, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_pgra)

#save coefficients of fits as object
cc_sma_pgra <- data.frame(coef(sma_pgra))

# Make plot ------
plot_pgra <- ggplot(pgra, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Phorcosergia grandis") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_pgra, aes(intercept = cc_sma_pgra[1,1], slope = cc_sma_pgra[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_pgra[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_pgra[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_pgra)
```

### _Robustasergia robusta_
```{r dev-rrob}

# Subset data -----
rrob <- specimens %>% filter(genus_species == "Robustasergia_robusta")

# Fit SMA model ------
sma_rrob <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = rrob, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_rrob, which = "default",type = "o") 
plot(sma_rrob, which = "residual",type = "o")
plot(sma_rrob, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_rrob)

#save coefficients of fits as object
cc_sma_rrob <- data.frame(coef(sma_rrob))

# Make plot ------
plot_rrob <- ggplot(rrob, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Robustasergia robusta") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_rrob, aes(intercept = cc_sma_rrob[1,1], slope = cc_sma_rrob[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_rrob[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_rrob[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_rrob)
```

### _Robustosergia regalis_
```{r dev-rreg}

# Subset data -----
rreg <- specimens %>% filter(genus_species == "Robustosergia_regalis")

# Fit SMA model ------
sma_rreg <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = rreg, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_rreg, which = "default",type = "o") 
plot(sma_rreg, which = "residual",type = "o")
plot(sma_rreg, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_rreg)

#save coefficients of fits as object
cc_sma_rreg <- data.frame(coef(sma_rreg))

# Make plot ------
plot_rreg <- ggplot(rreg, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Robustosergia regalis") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_rreg, aes(intercept = cc_sma_rreg[1,1], slope = cc_sma_rreg[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_rreg[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_rreg[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_rreg)
```

### _Sergestes atlanticus_
```{r dev-satl}

# Subset data -----
satl <- specimens %>% filter(genus_species == "Sergestes_atlanticus")

# Fit SMA model ------
sma_satl <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = satl, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_satl, which = "default",type = "o") 
plot(sma_satl, which = "residual",type = "o")
plot(sma_satl, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_satl)

#save coefficients of fits as object
cc_sma_satl <- data.frame(coef(sma_satl))

# Make plot ------
plot_satl <- ggplot(satl, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Sergestes atlanticus") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_satl, aes(intercept = cc_sma_satl[1,1], slope = cc_sma_satl[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_satl[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_satl[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_satl)
```

### _Sergia tenuiremis_
```{r dev-sten}

# Subset data -----
sten <- specimens %>% filter(genus_species == "Sergia_tenuiremis")

# Fit SMA model ------
sma_sten <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = sten, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_sten, which = "default",type = "o") 
plot(sma_sten, which = "residual",type = "o")
plot(sma_sten, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_sten)

#save coefficients of fits as object
cc_sma_sten <- data.frame(coef(sma_sten))

# Make plot ------
plot_sten <- ggplot(sten, aes(x = Body_Length, y = Eye_Diameter, col = Preservation)) + 
  geom_point(size = 2, alpha = 0.8) + 
  scale_color_manual(values = col_pres, name = "Sample state", breaks = c("ethanol", "fresh", "paraformaldehyde")) +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Sergia tenuiremis") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_sten, aes(intercept = cc_sma_sten[1,1], slope = cc_sma_sten[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_sten[2,1], digits = 2), sep = " "), size = 3, col = "black") +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_sten[1,1], digits = 2), sep = " "), size = 3, col = "black")

ggplotly(plot_sten)
```

### Figure for developmental eye-body scaling across sergestids

```{r figure-dev, fig.width = 10, fig.height = 12, results = "hide"}

#make figure panels
fig.a <- plot_parm + theme(legend.position = "none", axis.title.x = element_blank())
fig.b <- plot_pvig + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.c <- plot_dcor + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.d <- plot_dhen + theme(legend.position = "none", axis.title.x = element_blank())
fig.e <- plot_asar + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.f <- plot_apec + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.g <- plot_chan + theme(legend.position = "none", axis.title.x = element_blank())
fig.h <- plot_ctal + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.i <- plot_pgra + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.j <- plot_sten + theme(legend.position = "none", axis.title.x = element_blank())
fig.k <- plot_rrob + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.l <- plot_rreg + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())
fig.m <- plot_gspl +theme(legend.position = "none")
fig.n <- plot_satl + theme(legend.position = "none", axis.title.y = element_blank())
fig.o <- plot_nedw + theme(legend.position = "none", axis.title.y = element_blank())

# arrange panels in figure
plots <- plot_grid(fig.a, fig.b, fig.c, fig.d, fig.e, fig.f, fig.g, fig.h, fig.i, fig.j, fig.k, fig.l, fig.m, fig.n, fig.o, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I","J", "K", "L", "M", "N", "O"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 5) #number of rows in grids

#extract legend
leg <- get_legend(fig.a + theme(legend.position="bottom"))


#view figure
plot_grid(plots, leg, nrow = 2, rel_heights = c(1, .01), align = 'vh')

#export figure
png("../Figures/dev-allometry.png", width = 10, height = 12, units = "in", res = 500)
plot_grid(plots, leg, nrow = 2, rel_heights = c(1, .05), align = 'vh')
dev.off()
```

The plots here are scaled to fit the data, so they all look similar but the slopes are actually quite variable and I think pretty interesting. This could be worth exploring for a chunk of the paper, and we might consider examining variation in developmental scaling slopes as a factor of phylogeny and things like whether each species exhibits ontogenetic descent. 

## Test whether species differ in ontogenetic allometry

We've looked at how eyes scale with body size across species, but are there significant differences in these scaling relationships? The _smatr_ package also allows you to test whether groups exhibit significant differences in allometric scaling (slopes or intercepts). Below, we again use standardized major axis regression to model the scaling of eye diameter with body length across all specimens measured and test whether we see significant differences in developmental scaling across species. This is a bit redundant with above, but will provide statistical evidence of the (very big) difference in slopes among species. 

*Note: As we did not have sufficient sampling to estimate eye-body allometry for _Neosergestes edwardsii_, I've removed it from the specimen dataset before fitting this model.

This test shows that among N = 445 sergestid speciments, species significantly differ in their allometric scaling relationships between eye diameter and body length (p < 0.0001). It also yields a table of pairwise comparisons so you can see exactly which species differ significantly in slope and which do not. 

```{r species-smas}

#Remove outliers from specimen dataset
specimens_ed <- specimens %>%
  filter(!(genus_species == "Allosergestes_sargassi" & Eye_Diameter == 0.67 & Body_Length == 12.97)) %>%
  filter(!(genus_species == "Gardinerosergia_splendens" & Eye_Diameter == 1.71 & Body_Length == 21.98)) %>%
  filter(!(genus_species == "Neosergestes_edwardsii" & Eye_Diameter == 0.85 & Body_Length == 0.72))
  
#Remove Neosergestes edwardsii from dataset for SMA
specimens_sma <- specimens_ed %>%
  filter(genus_species != "Neosergestes_edwardsii") %>%
  mutate(species_text = as.factor(paste(Genus, Species, sep = " "))) # Add labels for species
  
# Model for developmental scaling across specimens grouped by species
sma_species <- sma(formula = Eye_Diameter ~ Body_Length * genus_species, 
            data = specimens_sma, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            multcomp = TRUE, # adds pairwise comparisons between groups
            multcompmethod = "adjusted", # adjusts p-value for multiple comparisons
            alpha = 0.05) 

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_species, which = "default",type = "o") 
plot(sma_species,which = "residual",type = "o")
plot(sma_species, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_species)

#save coefficients of fits as object
cc_species <- data.frame(coef(sma_species))
```

This figure shows the ontogenetic allometry of all the species with sufficient sampling (n = 14). It's interactive, so you can click on different species in the legend to hide or show those points. That can be helpful for exploring patterns in a big mess of data. To me, it looks a bit like the smaller-bodied species have higher slopes? It looks like _Sergestes atlanticus_, _Allosergestes_pectinatus_, and _Parasergestes vigilax_ have different (higher) slopes compared to the other sergestids, and the other species differ a bit in slopes but more so in intercepts. 

```{r species-fig, fig.width=9, fig.height=9}
#make shape pallette
shapes.sp <- c("Allosergestes pectinatus" = 21,
              "Allosergestes sargassi" = 22, 
              "Challengerosergia hansjacobi" = 23, 
              "Challengerosergia talismani" = 24,
              "Deosergestes corniculum" = 25 , 
              "Deosergestes henseni" = 21, 
              "Gardinerosergia splendens" = 22, 
              "Parasergestes armatus" = 23, 
              "Parasergestes vigilax" = 24, 
              "Phorcosergia grandis" = 25, 
              "Robustasergia robusta" = 21 ,
              "Robustosergia regalis" = 22,
              "Sergestes atlanticus" = 23,
              "Sergia tenuiremis" = 24)

#make color pallette
cols.sp <- c("Allosergestes pectinatus" = "#a6cee3",
              "Allosergestes sargassi" = "#1f78b4", 
              "Challengerosergia hansjacobi" = "#b2df8a", 
              "Challengerosergia talismani" = "#33a02c",
              "Deosergestes corniculum" = "#fb9a99" , 
              "Deosergestes henseni" = "#e31a1c", 
              "Gardinerosergia splendens" = "#fdbf6f", 
              "Parasergestes armatus" = "#ff7f00", 
              "Parasergestes vigilax" = "#cab2d6", 
              "Phorcosergia grandis" = "#6a3d9a", 
              "Robustasergia robusta" ="gray31" ,
              "Robustosergia regalis" = "black",
              "Sergestes atlanticus" = "maroon1",
              "Sergia tenuiremis" = "orchid1")

#set s limits by species for plots
limits <- specimens_sma %>%
  group_by(genus_species) %>%
  summarise(max = max(Body_Length, na.rm = TRUE),
            min = min(Body_Length, na.rm = TRUE))


#make plot
plot_species <- ggplot(specimens_sma, aes(x = Body_Length, y = Eye_Diameter, color =  species_text, shape = species_text, fill = species_text)) + 
  geom_point(size = 2.5, alpha = 0.7) + 
  scale_shape_manual(values = shapes.sp, name = "Species") + 
  scale_color_manual(values = cols.sp, name = "Species") +
  scale_fill_manual(values = cols.sp, name = "Species") +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(face = "italic")) +
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Allosergestes_pectinatus")], xend = limits$max[which(limits$genus_species == "Allosergestes_pectinatus")], y = 10^(log10(limits$min[which(limits$genus_species == "Allosergestes_pectinatus")])*cc_species["Allosergestes_pectinatus", "slope"] + cc_species["Allosergestes_pectinatus", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Allosergestes_pectinatus")])*cc_species["Allosergestes_pectinatus", "slope"] + cc_species["Allosergestes_pectinatus", "elevation"])), color = cols.sp["Allosergestes pectinatus"]) + #Rana temporaria adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Allosergestes_sargassi")], xend = limits$max[which(limits$genus_species == "Allosergestes_sargassi")], y = 10^(log10(limits$min[which(limits$genus_species == "Allosergestes_sargassi")])*cc_species["Allosergestes_sargassi", "slope"] + cc_species["Allosergestes_sargassi", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Allosergestes_sargassi")])*cc_species["Allosergestes_sargassi", "slope"] + cc_species["Allosergestes_sargassi", "elevation"])), color = cols.sp["Allosergestes sargassi"]) + #Allosergestes_sargassi adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Challengerosergia_hansjacobi")], xend = limits$max[which(limits$genus_species == "Challengerosergia_hansjacobi")], y = 10^(log10(limits$min[which(limits$genus_species == "Challengerosergia_hansjacobi")])*cc_species["Challengerosergia_hansjacobi", "slope"] + cc_species["Challengerosergia_hansjacobi", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Challengerosergia_hansjacobi")])*cc_species["Challengerosergia_hansjacobi", "slope"] + cc_species["Challengerosergia_hansjacobi", "elevation"])), color = cols.sp["Challengerosergia hansjacobi"]) + #Challengerosergia_hansjacobi adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Challengerosergia_talismani")], xend = limits$max[which(limits$genus_species == "Challengerosergia_talismani")], y = 10^(log10(limits$min[which(limits$genus_species == "Challengerosergia_talismani")])*cc_species["Challengerosergia_talismani", "slope"] + cc_species["Challengerosergia_talismani", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Challengerosergia_talismani")])*cc_species["Challengerosergia_talismani", "slope"] + cc_species["Challengerosergia_talismani", "elevation"])), color = cols.sp["Challengerosergia talismani"]) + #Challengerosergia_talismani adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Deosergestes_corniculum")], xend = limits$max[which(limits$genus_species == "Deosergestes_corniculum")], y = 10^(log10(limits$min[which(limits$genus_species == "Deosergestes_corniculum")])*cc_species["Deosergestes_corniculum", "slope"] + cc_species["Deosergestes_corniculum", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Deosergestes_corniculum")])*cc_species["Deosergestes_corniculum", "slope"] + cc_species["Deosergestes_corniculum", "elevation"])), color = cols.sp["Deosergestes corniculum"]) + #Deosergestes_corniculum adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Deosergestes_henseni")], xend = limits$max[which(limits$genus_species == "Deosergestes_henseni")], y = 10^(log10(limits$min[which(limits$genus_species == "Deosergestes_henseni")])*cc_species["Deosergestes_henseni", "slope"] + cc_species["Deosergestes_henseni", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Deosergestes_henseni")])*cc_species["Deosergestes_henseni", "slope"] + cc_species["Deosergestes_henseni", "elevation"])), color = cols.sp["Deosergestes henseni"]) + #Deosergestes henseni adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Gardinerosergia_splendens")], xend = limits$max[which(limits$genus_species == "Gardinerosergia_splendens")], y = 10^(log10(limits$min[which(limits$genus_species == "Gardinerosergia_splendens")])*cc_species["Gardinerosergia_splendens", "slope"] + cc_species["Gardinerosergia_splendens", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Gardinerosergia_splendens")])*cc_species["Gardinerosergia_splendens", "slope"] + cc_species["Gardinerosergia_splendens", "elevation"])), color = cols.sp["Gardinerosergia splendens"]) + #Gardinerosergia splendens adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Parasergestes_armatus")], xend = limits$max[which(limits$genus_species == "Parasergestes_armatus")], y = 10^(log10(limits$min[which(limits$genus_species == "Parasergestes_armatus")])*cc_species["Parasergestes_armatus", "slope"] + cc_species["Parasergestes_armatus", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Parasergestes_armatus")])*cc_species["Parasergestes_armatus", "slope"] + cc_species["Parasergestes_armatus", "elevation"])), color = cols.sp["Parasergestes armatus"]) + #Parasergestes armatus adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Parasergestes_vigilax")], xend = limits$max[which(limits$genus_species == "Parasergestes_vigilax")], y = 10^(log10(limits$min[which(limits$genus_species == "Parasergestes_vigilax")])*cc_species["Parasergestes_vigilax", "slope"] + cc_species["Parasergestes_vigilax", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Parasergestes_vigilax")])*cc_species["Parasergestes_vigilax", "slope"] + cc_species["Parasergestes_vigilax", "elevation"])), color = cols.sp["Parasergestes vigilax"]) + #Parasergestes vigilax adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Phorcosergia_grandis")], xend = limits$max[which(limits$genus_species == "Phorcosergia_grandis")], y = 10^(log10(limits$min[which(limits$genus_species == "Phorcosergia_grandis")])*cc_species["Phorcosergia_grandis", "slope"] + cc_species["Phorcosergia_grandis", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Phorcosergia_grandis")])*cc_species["Phorcosergia_grandis", "slope"] + cc_species["Phorcosergia_grandis", "elevation"])), color = cols.sp["Hyla meridiondalis"]) + #Phorcosergia grandis adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Robustasergia_robusta")], xend = limits$max[which(limits$genus_species == "Robustasergia_robusta")], y = 10^(log10(limits$min[which(limits$genus_species == "Robustasergia_robusta")])*cc_species["Robustasergia_robusta", "slope"] + cc_species["Robustasergia_robusta", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Robustasergia_robusta")])*cc_species["Robustasergia_robusta", "slope"] + cc_species["Robustasergia_robusta", "elevation"])), color = cols.sp["Robustasergia robusta"]) + #Robustasergia robusta adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Robustosergia_regalis")], xend = limits$max[which(limits$genus_species == "Robustosergia_regalis")], y = 10^(log10(limits$min[which(limits$genus_species == "Robustosergia_regalis")])*cc_species["Robustosergia_regalis", "slope"] + cc_species["Robustosergia_regalis", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Robustosergia_regalis")])*cc_species["Robustosergia_regalis", "slope"] + cc_species["Robustosergia_regalis", "elevation"])), color = cols.sp["Robustosergia regalis"]) +
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Sergestes_atlanticus")], xend = limits$max[which(limits$genus_species == "Sergestes_atlanticus")], y = 10^(log10(limits$min[which(limits$genus_species == "Sergestes_atlanticus")])*cc_species["Sergestes_atlanticus", "slope"] + cc_species["Sergestes_atlanticus", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Sergestes_atlanticus")])*cc_species["Sergestes_atlanticus", "slope"] + cc_species["Sergestes_atlanticus", "elevation"])), color = cols.sp["Sergestes atlanticus"]) +
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Sergia_tenuiremis")], xend = limits$max[which(limits$genus_species == "Sergia_tenuiremis")], y = 10^(log10(limits$min[which(limits$genus_species == "Sergia_tenuiremis")])*cc_species["Sergia_tenuiremis", "slope"] + cc_species["Sergia_tenuiremis", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Sergia_tenuiremis")])*cc_species["Sergia_tenuiremis", "slope"] + cc_species["Sergia_tenuiremis", "elevation"])), color = cols.sp["Sergia tenuiremis"])


#interactive plot
ggplotly(plot_species)
```

```{r, results = "hide"}
#export figure
png("../Figures/dev-species.png", width = 12, height = 12, units = "in", res = 500)
plot_species
dev.off()
```

## Test for effect of preservation

To test whether preservation type affects eye-body allometry, we have used an additional linear model that includes all specimens (n = 451) and species (n = 15). This model its a fits a regression of eye size vs. body size with both species and preservation type as covariates, and looks for an interaction effect between species and preservation. Specifically, this tests whether preservation type (fresh, ethanol, paraformaldehyde) has an effect on eye size, and whether this differs across species.

```{r pres-smas}

# Model for developmental scaling across specimens * species * preservation
lm_pres <- lm(formula = Eye_Diameter ~ Body_Length * genus_species * Preservation, data = specimens_ed) 

#view anova table (see effects of variables)
anova(lm_pres)
```

The ANOVA table shows that, as we knew, body length, species, and their interaction all have significant effects on eye size (this indicates species specific patterns of ontogenetic scaling). However, preservation also has a significant effect on eye size (p < 0.0001), as does the interaction between species and preservation (p = 0.005). 

This indicates that we should probably consider preservation error in our analyses, however, since the effect of preservation varies across species and some species have small sample sizes (especially if you break down by preservation type), it is tricky to come up with a correction. My suggestion is that we acknowledge this issue in the results and mention in the discussion how it might affect our interpretations, but also discuss that there does not seem to be a clear, consistent, large-mangitude effect of preservation across our species data plots. 

## Phylogenetic distribution of allometric slopes

Below, we plot species-specific slopes for developmental eye-body allometry onto the sergestid tree. There is potential to do more with these data; do we have predictions for what might drive species differences in developmental allometry? It looks like body size might be one factor, as the smaller-bodied species seem to have higher slopes. Whether species exhibit ontogenetic descent may be another factor to explore? We might predict that species that have ontogenetic descent and are going into dimmer habitats as they grow may invest in higher eye growth relative to body growth. Do all sergestids exhibit ontogenetic descent? So far, all I've done with these data in an evolutionary framework is test for phylogenetic signal. Let me know if you think of anything else cool to look at! Maybe we could test whether larger body sizes are correlated with lower slopes? Seemed from the plot of all the species that maybe the smaller bodied species had the higher slopes..

```{r slope-phylo, results = "hide", fig.width=10, fig.height=7}

#Add slopes for developmental allometry into species dataframe ----

#add coefficient rownames to genus_species column
cc_species$genus_species <- rownames(cc_species)

#merge coefficients with species data by rowname
species_sma <- left_join(traits, cc_species, by = "genus_species") %>%
  filter(genus_species != "Neosergestes_edwardsii")

# Prep data and phylogeny -----

#Make list of taxa to drop (in tree but not in dataset)
drops <- setdiff(tree$tip.label, as.character(species_sma$Binomial))

#Drop unwanted tips from phylogeny
tree.dev <- drop.tip(phy = tree, tip = drops) 

# Make Genus_species tip labels to replace Binomial codes
sp.tips <- data.frame(old = species_sma$Binomial, new = species_sma$genus_species)

# replace tip labels in phylogeny
tree.dev.plot <- sub.taxa.label(tree.dev, sp.tips)

#change row names of species data
rownames(species_sma) <- species_sma$genus_species

#check that phylogeny and data match exactly
name.check(tree.dev.plot, species_sma)

#resort trait dataset to the order of tree tip labels
species_sma <- species_sma[tree.dev.plot$tip.label, ] 

#make trait vector for slope
slope <- as.vector(species_sma$slope) 

#add tip label names to vector
names(slope) <- species_sma$genus_species

# Phylogeny with slopes for developmental eye-body allometry----
plotTree.wBars(tree.dev.plot, slope, 
               scale = 0.5, 
               tip.labels = TRUE,
               offset = 0.1,
               ftype = "bi",
               fsize = 1)

#export figure
png("../Figures/dev-phylo.png", width = 10, height = 7, units = "in", res = 500)

plotTree.wBars(tree.dev.plot, slope, 
               scale = 0.5, 
               tip.labels = TRUE,
               offset = 0.1,
               ftype = "bi",
               fsize = 1)

dev.off()
```

```{r slope-sig}

#fit Pagel's lambda in caper
slopes <- data.frame(slope, names(slope))
mod <- pgls(slope ~ 1, comparative.data(tree.dev.plot, slopes,"names.slope."), lambda="ML")

#summary of model
summary(mod)

#plot likelihood of lambda
plot(pgls.profile(mod, "lambda"))

```

A test for phylogenetic signal implemented in _caper_ indicates that the estimate for Pagel's lambda is 0.78. However, this estimate was not significant, and neither the upper or lower bound of the confidence interval could be estimated. This could indicate that there is no phylogenetic signal in these data, but could also be the result of our very small sample size of species for comparative evolutionary models (n = 14). Simulations have previously found that estimating Pagel's lambda for datasets of >20 species is problematic and often unreliable (see Freckleton et al., 2002). The likelihood profile of lamda shows that there is increased likelihood that it's somewhere between 0.5 and 1. 

# Evolutionary eye-body allometry in Sergestidae

We next examine interspecific (evolutionary) eye-body allometry across sergestids using species means for eye diameter and body length. In calculating species means, we want to use adults only and also make sure that the data we use downstream for traits is relevent to the size class of individuals that we are taking species means from. The biggest concern for the Sergestidae is ontogenetic descent, as this is common across midwater animals and could convolute relationships between eye size and depth. However, body size for 'adult' depth distribution data we used in this paper was cutoff between 4-11mm depending on species, and our smallest specimen here is 12.97mm, so we are confident that species averages based on full species samples in our dataset are appropriate here. 

Below, we use phylogenetic least-squares regression (using the _caper_ package) to fit the allometric relationship between species means for eye size and body length across 15 species of sergestids.

Note: the removal of 3 outlier specimens has slightly changed 3 species means from what they are compiled in the original spreadsheet. I have recalculated all species means here from the specimen data with outliers removed and used those values for analyses. I merged these data with the trait data from the original species datasheet for analyses. 

```{r evo-pgls, results = "hide"}

# Prep data ------

#Calculate species means (3 outliers removed)
sp_means <- specimens_ed %>% 
  mutate_if(is.character, as.factor) %>% 
  group_by(genus_species) %>%
  summarise(eye_av = mean(Eye_Diameter), 
            length_av = mean(Body_Length), 
            n = n()) %>%
  ungroup()

#Merge with species trait data stored in dataframe 'species'
species <- traits %>%
  left_join(sp_means, by = "genus_species")

#check that names match in dataframe and tree
name.check(phy = tree, data = species, data.names = species$Binomial)
  
#use caper function to combine phylogeny and data into one object (this function also matches species names in tree and dataset)
species.comp <- comparative.data(data = species, phy = tree, names.col = "Binomial", vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE)

#check for dropped tips or dropped species
species.comp$dropped$tips #phylogeny
species.comp$dropped$unmatched.rows #dataset

# PGLS model -------

#fit model for eye diameter ~ body length
pgls_evo <- pgls(log10(eye_av) ~ log10(length_av), 
               data = species.comp, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_evo)
par(mfrow = c(1, 1))
```

The standard model checks for the PGLS of interspecific eye diameter vs. body length are a bit wonky. The residuals look bimodal (though don't have huge weird outliers) and the q-q plot is a bit funky. We'll have to dedide if we're ok with this. Assuming we accept thsi, model results are below. 

```{r}
#print model output 
summary(pgls_evo)

#save coefficients of fits as object
cc_pgls_evo <- data.frame(coef(pgls_evo))
```

The PGLS regression shows that eyes scale with body length with a slope of 0.85, indicating that eyes have a negative allometry (hypoallometric, slope < 1) with body size. This is what is most common among all vertebrates and some invertebrates that have been examined so far (inverts tend to vary a lot more than verts). 

```{r}

#Likelihood plot for Pagel's lambda 
lambda.evo <- pgls.profile(pgls_evo, "lambda")
plot(lambda.evo, main = "Pagel's lambda", 
     sub = "Solid red line indicates estimate for lambda and broken red lines indcaite the 95% confidence interval")

```

The maximum likelihood estimate of lambda is 1.00 (high phylogenetic signal/Brownian Motion), so that's what _caper_ has used to create the variance-covariance matrix for the regression. However, small sample sizes (< 20-30 data points) have no/little power to estimate lambda (see Freckleton et al. 2002), so tests for phylogenetic signal in this dataset are essentially meaningless (note that the 95% confidence interval for lambda here is 0 to 1, all possible values, and the p-values are non-signficant). For this reason, if any of our other comparative analyses estimate a lambda of 0, we should repeat them again forcing lambda to 1, just so we can see what difference that makes in the model fits (as we can't know what lambda actually is in this small dataset). 

Alternatively, we could run all models with lambda set to 0 (which ignores phylogeney) and again to 1 (highest phylogenetic signal) so that we can bin the possible results into the possible extremes and understand the potential effect of phylogeny. This is probably the most reasonable approach for all of our comparative models given the sample size. 

```{r}

# Make plot 
plot_evo <- ggplot(species, aes(x = Body_length, y = Eye_diameter, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  geom_abline(data = cc_pgls_evo, aes(intercept = cc_pgls_evo[1,1], slope = cc_pgls_evo[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_pgls_evo[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_pgls_evo[1,1], digits = 2), sep = " "), size = 3)

# Interactive plot
ggplotly(plot_evo)

```

# Correlates of eye size in deep-sea sergestid shrimp

Next, we examine whether varition in eye size is correlated with ecological variables related to light regime and vision: depth and bioluminescent organs. 

## Phylogenetic distribution of eye size and ecology

Here, we examine how absolute and relative eye size vary across the sergestid phylogeny, and the corresponding distribution ecological variables. For visualizing relative eye size, we use the residuals of the PGLS fit for eye-body allometry, as these show eye size corrected by both body size and evolutionary relationships.  

Note: There are few enough species that it would be really nice to put an image of each species next to the phylogeny/associated data if you have them. If not photos, we could make vector images of species sillhouettes and scale them by body size. That would look nice and provide some additional useful information on the figure.

```{r eyesize-phylo, results = "hide", fig.width=6, fig.height=4, fig.cap = "Phylogeny of the 15 sertestids sampled depicting absolute eye diameter (purple circles scaled by absolute size), relative eye investment (bars scaled by the residuals from the PGLS of eye diameter vs. body length), and photophore complexity (colored boxes)."}

#Add residuals from PGLS fits to dataframe ----

#extract pgls residuals 
pglsres <- residuals(pgls_evo) 

#name residuals
colnames(pglsres) <- "pglsres" 

#add rownames to species dataframe
rownames(species) <- species$Binomial

#merge residuals with species data by rowname
species.phy <- merge(species, pglsres, by = "row.names") 

#make column converted to observed eye size as factor of PGLS fit
species.phy$eyefactor <- 10^species.phy$pglsres

# Prep phylogeny -----

# Make Genus_species tip labels to replace Binomial codes
sp.tips <- data.frame(old = species.phy$Binomial, new = species.phy$genus_species)

# replace tip labels in phylogeny
tree.plot <- sub.taxa.label(tree, sp.tips)

# Prep data ----

#change row names of species data
rownames(species.phy) <- species.phy$genus_species

#check that phylogeny and data match exactly
name.check(tree.plot, species.phy)

#resort trait dataset to the order of tree tip labels
species.phy <- species.phy[tree.plot$tip.label, ] 

#make trait vector for absolute eye size
aveye <- as.vector(species.phy$eye_av) 
names(aveye) <- species.phy$genus_species

#make trait vector for eye investment (PGLS residuals)
releye <- as.vector(species.phy$pglsres) #residuals of pgls
names(releye) <- species.phy$genus_species

# Phylogeny with eye size and investment -------

#color vector for photophores
col_ph <- c("lensed" = "palegreen",
            "none" = "honeydew",
            "pesta" = "cadetblue1",
            "unlensed" = "orchid1")

#plot tree with eye investment bars
plotTree.wBars(tree.plot, releye, 
               scale = 1.5, 
               tip.labels = TRUE,
               col = unname(col_ph[as.factor(species.phy$Organ)]),
               offset = 1,
               ftype = "bi",
               fsize = 0.7)

#add tip labels for absolute eye size
tiplabels(cex = 1.5*aveye,
          pch = 19, #shape of labels
          col = "mediumpurple",
          offset = 0)

#add legend for photophores
legend(x = "bottomleft", legend = c("lensed", "none", "pesta", "unlensed"), pch = 22, pt.cex= 2, pt.bg = col_ph, cex = 1, bty = "n", horiz = F)


#Export figure------
pdf("../Figures/phylo.pdf", width = 6, height = 4)

#plot tree with eye investment bars
plotTree.wBars(tree.plot, releye, 
               scale = 1.5, 
               tip.labels = TRUE,
               col = unname(col_ph[species.phy$Organ]),
               offset = 1,
               ftype = "bi",
               fsize = 0.7)

#add tip labels for absolute eye size
tiplabels(cex = 1.5*aveye,
          pch = 19, #shape of labels
          col = "mediumpurple",
          offset = 0)

#add legend for photophores
legend(x = "bottomleft", legend = c("lensed", "none", "pesta", "unlensed"), pch = 22, pt.cex= 2, pt.bg = col_ph, cex = 1, bty = "n", horiz = F)


dev.off()
```

The above plot shows the sergested phylogeny with absolute eye size (purple points scaled by eye diameter), relative eye size (scaled bars, residuals of eye vs. body pgls), and photopore type (bar colors). Note: we can (and should) change the colors on this or make BW. We can refine and probably merge with depth distribution phylogeny for a paper figure.


```{r, fig.width=8, fig.height=5.5}

# tree showing day and night mean depths across species

#fix node order upset by ladderization

#filter out internal nodes from second column of edge matrix
is_tip <- tree.plot$edge[,2] <= length(tree.plot$tip.label)
ordered_tips <- tree.plot$edge[is_tip, 2]

#extract tips in right order
tree.plot$tip.label[ordered_tips]

#resort trait dataset to the order of tree tip labels
species.phy <- species.phy[tree.plot$tip.label[ordered_tips], ] 

#make trait vector for day depth
day <- as.vector(species.phy$Day_Avg) 
names(day) <- species.phy$genus_species

#make trait vector for night depth
night <- as.vector(species.phy$Night_Avg) 
names(night) <- species.phy$genus_species

#Plot tree with depth ranges
plot(tree.plot, 
     show.tip.label= TRUE, 
     font=3, 
     cex=3, 
     label.offset = 0.62, 
     edge.width=4)

#add gray bar for difference in day/night depths (migration distance)
segments(1.05 + (day*0.0003), 1:length(day), 1.05 + (night*0.0003), 1:length(night), col="gray", lwd=20)

#add yellow point for day depth
segments(1.05 + (day*0.0003), 1:length(day), 1.05 + (day*0.0003), 1:length(day), col="orange", lwd=25)

#add blue point for night depth
segments(1.05 + (night*0.0003), 1:length(night), 1.05 + (night*0.0003), 1:length(night), col="royalblue2", lwd=25)

# export figure 
pdf("../Figures/phylodepth.pdf", width = 8, height = 5.5)

#Plot tree with depth ranges
plot(tree.plot, 
     show.tip.label= TRUE, 
     font=3, 
     cex=0.9, 
     label.offset = 0.62, 
     edge.width=2)

#add gray bar for difference in day/night depths (migration distance)
segments(1.05 + (day*0.0003), 1:length(day), 1.05 + (night*0.0003), 1:length(night), col="gray", lwd=8)

#add yellow point for day depth
segments(1.05 + (day*0.0003), 1:length(day), 1.05 + (day*0.0003), 1:length(day), col="orange", lwd=10)

#add blue point for night depth
segments(1.05 + (night*0.0003), 1:length(night), 1.05 + (night*0.0003), 1:length(night), col="royalblue2", lwd=10)

dev.off()

```

The above plot shows the average daytime (orange) and nighttime (blue) depths for each species in the phylogeny. Gray bars indicate vertical distance traveled during diel vertical migrations. (Note that this plot is missing a scale bar, easier to add in Illustrator, but min depth on left/blue is 133m and max depth on right/orange is 1750m).

## Visualizing eye size and ecology 

The following are exploratory plots that do not account for the phylogenetic distribution of traits. Plots are interactive: hover over a data point to see the species and x/y values.  

### Photophore complexity 

**Prediction:** We might predict that species that have highly developed photophrores may be more likely to engage in visual signaling, and thus may have higher investments in eye size. However, this is the opposite of what we see here (species with organs of pesta have the smallest eyes and the lowest relative investment in eye size). As BL can also be used for camouflage, and BL from other species is ubiquitous, there is a reasonable expectation that they could be uncorrelated as well.

```{r photo-viz}

#Boxplots for absolute eye size across photophores -----
plot_abs_photo <- ggplot(data = species.phy, aes(x = reorder(Organ, Eye_diameter, FUN = mean), y = Eye_diameter)) + 
  geom_boxplot(notch = FALSE, outlier.shape = NA, alpha = 0.6) + #controls boxes
  stat_summary(fun.y = mean, colour = "black", geom = "point", shape = 18, size = 3, show_guide = FALSE) + #controls what stats shown
 geom_jitter(shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) + #controls background
  xlab("Photophore complexity") +
  ylab("Eye diameter (mm)") +
  ggtitle("Absolute eye size")

ggplotly(plot_abs_photo)

#Boxplots for relative eye investment across photophores -----
plot_rel_photo <- ggplot(data = species.phy, aes(x = reorder(Organ, pglsres, FUN = mean), y = pglsres)) + 
  geom_boxplot(notch = FALSE, outlier.shape = NA, alpha = 0.6) + #controls boxes
  stat_summary(fun.y = mean, colour = "black", geom = "point", shape = 18, size = 3, show_guide = FALSE) + #controls what stats shown
 geom_jitter(shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) + #controls background
  xlab("Photophore complexity") +
  ylab("Relative eye investment") +
  ggtitle("Relative eye investment")

ggplotly(plot_rel_photo) 


```

### Maximum depth

**Prediction:** We might expect that eye size would increase with maximum depth to some point, then may level off and become uncorrelated once the pelagic zone occupied lacks downwelling light for vision. Maximum recorded depth isn't the best indicator of where an animal actually spends its time, so we could expect that the actual depth occupied at the brightest time of day could be somewhere a bit shallower than these values, so tough to say whether and where leveling off might occur. 

Visual inspection of the data shows that absolute eye size does seem to increase with maximum depth. However, body size also increases with maximum depth, and both relative eye size (eye/body) and eye investment (residuals of PGLS for eye ~ body) show litte to no correlation with maximum depth. 

```{r depth-viz}

# Absolute eye size by max depth ------
plot_abs_max <- ggplot(species.phy, aes(x = Eye_diameter, y = Max, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_abs_max)

# Body size with max depth -----
plot_body_max <- ggplot(species.phy, aes(x = Body_length, y = Max, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Body length (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_body_max)

# Eye size/body size with max depth -----
plot_eb_max <- ggplot(species.phy, aes(x = Relative_size, y = Max, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye:body") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_eb_max)

# Relative eye investment by max depth -----
plot_inv_max <- ggplot(species.phy, aes(x = eyefactor, y = Max, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Relative eye investment") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_inv_max)

# Absolute eye size by depth range -----
plot_abs_range <- ggplot(species.phy, aes(x = Eye_diameter, y = (Max - Min), text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Depth range (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_abs_range)

# Relative eye investment by depth range -----
plot_inv_range <- ggplot(species.phy, aes(x = eyefactor, y = (Max - Min), text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Depth range (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Relative eye investment") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_inv_range)


# Absolute eye size by mid depth -----

#add column for midpoint of depth range
species.phy <- species.phy %>%
  mutate(depth_mid = ((Max - Min)/2) + Min)

#plot
plot_abs_mid <- ggplot(species.phy, aes(x = Eye_diameter, y = depth_mid, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Midpoint depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_abs_mid)

# Relative eye investment by mid depth -----
plot_inv_mid <- ggplot(species.phy, aes(x = eyefactor, y = depth_mid, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Midpoint depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Relative eye investment") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_inv_mid)

```


## Comparative models

### Eye diameter ~ body length * photophore complexity

Below, I run a PGLS model of log10(eye diameter) vs. log10(body length) with photophore complexity as a covariate (= phylogenetic ANCOVA). Because we have so many states for photophore complexity and a small sample of species, we cannot look at the interaction term for body size x photophore complexity because then our states outnumber our number of observations.

```{r pgls-photo}

#run PGLS modelusing the Maximum Liklihood estimate of lambda
pgls_photo <- pgls(log10(Eye_diameter) ~ log10(Body_length) + Organ, 
               data = species.comp, 
               lambda = "ML",
               #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#evaluate model assumptions
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(pgls_photo) #plot the linear model
par(mfrow = c(1,1)) #set plotting window back to one plot
```

#### Model outputs

This output from anova(model) gives the overall significance of the main, 2-way, 3-way, etc. interactions and sequential sums of squares. Here we can see that body length has a significant effect on eye size (expected, and we already knew that), but we also find that photophore complexity has a significant effect on eye size when the effect of body size is accounted for (p = 0.01).

```{r}
#anova
anova(pgls_photo)
```

This output from summary(model) gives PGLS coefficients as well significance with respect to contrasts. Note that for a categorical variable, R will treat whichever factor comes first as the "control" and will test other factors for significant differences relative to that "control". Here, the comparison state ("control") for photophore complexity is set to "unlensed" (estimate listed under (Intercept) - that's why you don't see that state as a comparison line) and the other states show the *difference* in the estimated intercept for that state compared to the unlensed state, and whether that difference is significant. You can see that "none" and "lensed" show no significant difference in intercept from "unlensed", but that "pesta" does show a significant difference (p = 0.01) and has a lower intercept, indicating smaller relative eye size. 

The output also includes the maximum-likelihood estimation of lambda, which represents the phylogenetic signal for PGLS model *residuals*. Here, the estimate for lambda is 0.00, which means that there is no phylogenetic signal. This doesn't mean we shouldn't include phylogeny in the model (no reason not to), but it does mean that it's the same result we would get if we assessed this without including phylogeny. This also doesn't mean that there is not phylogenetic signal in the individual traits that we put into the model; this is only lambda for the *model residuals*, not the traits themselves.

```{r}
#summary
summary(pgls_photo)
```


### Eye diameter ~ body length + maximum depth

Below, I run a PGLS model of klg10(eye diameter) vs. log10(body length) with maximum depth as a covariate. This model does not test for the interaction between body length and maximum depth. 

**Question to consider:** Should we log maximum depth in these analyses? Allometric data are typically logged and I have done so throughout these analyses. Depth you could argue either way, but since light attenuates exponentially with depth and we are thinking about light environment here I'd be inclined to log? Currently, eye size and body size are logged and depth is unlogged in the below analysis. 

```{r pgls-depth}

#run PGLS modelusing the Maximum Liklihood estimate of lambda
pgls_depth <- pgls(log10(Eye_diameter) ~ log10(Body_length) + Max, 
               data = species.comp, 
               lambda = "ML", bounds = list(lambda = c(1e-05, 1)),
               #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#evaluate model assumptions
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(pgls_depth) #plot the linear model
par(mfrow = c(1,1)) #set plotting window back to one plot
```

#### Model outputs

This output from anova(model) gives the overall significance of the main effects and sequential sums of squares. Here we can see that body length has a significant effect on eye size when depth is corrected for (expected, and we already knew that), but that maximum depth also has a significant effect on eye size corrected for the effects of body size (p < 0.05).

Note: I originally ran this model with an additional interaction term for depth x body length, and there was not a significant effect for maximum depth (p = 0.05) or the interaction between max depth and body length (p = 0.67). Note though that depth was very close to being significant, so this may result from our low species sample size (n = 15) combined with additional model paramaterization yielding less statistical power; additional species sampling may yield a different result. 

Second note: There is a postitive relationship between body size and maximum depth in these data (body length increases with maximum depth). This raises some concern about multicolinearity, as these models assume that our two predictive variables are independent of each other (and in this case, that is at least partially false). The finding that species mean body size increases with maximum depth could be a potentially interesting thing to have a look at as well, there are a number of studies looking at body size with depth in the deep ocean so it's definitely of interest, I think especially people thinking about carbon/food availability. 

```{r}
#anova
anova(pgls_depth)
```

This output from summary(model) gives PGLS coefficients as well significance with respect to contrasts. 

The output also gives a maximum-likelihood estimation of lambda = 0.00, indicating that there is no phylogenetic signal in the residuals of the model (and that caper used a lambda of 0 to set the variance-covariance matrix in the regression). However, small sample sizes have no power to estimate the true value of lambda, so this is not very meaningful in this dataset. We should decide on a strategy for analysis (as mentioned above, may want to run all models again with lambda fixed at 1 as a comparison for the supp info).

```{r}
#summary
summary(pgls_depth)
#Here, the fit for predicting log10(eye size) is -1.18 + log10(0.64 * Body length) + log10(0.0001 * Max depth)
```

### Eye diameter ~ body length * depth range

Below, I run a PGLS model of log10(eye diameter) vs. log10(body length) with depth range as a covariate. This model does not test for the interaction between body length and depth range. 

```{r pgls-range}

#run PGLS modelusing the Maximum Liklihood estimate of lambda
pgls_range <- pgls(log10(Eye_diameter) ~ log10(Body_length) + (Max - Min), 
               data = species.comp, 
               lambda = "ML", bounds = list(lambda = c(1e-05, 1)),
               #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#evaluate model assumptions
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(pgls_range) #plot the linear model
par(mfrow = c(1,1)) #set plotting window back to one plot
```

#### Model outputs

This output from anova(model) gives the overall significance of the main effects and sequential sums of squares. Both body length (as expected) and depth range (p < 0.05) show significant effects on eye size. 

```{r}
#anova
anova(pgls_range)
```

This output from summary(model) gives PGLS coefficients as well significance with respect to contrasts. 

The output also gives a maximum-likelihood estimation of lambda = 0.00, indicating that there is no phylogenetic signal in the residuals of the model (and that caper used a lambda of 0 to set the variance-covariance matrix in the regression). However, small sample sizes have no power to estimate the true value of lambda, so this is not very meaningful in this dataset. We should decide on a strategy for analysis (as mentioned above, may want to run all models again with lambda fixed at 1 as a comparison for the supp info).

You can see below that the coefficients are really similar to those for max depth. I think that's because in many cases depth range = max depth (min depth only varies between 0 and 300 m). They are both probably showing pretty much the same thing here. 

```{r}
#summary
summary(pgls_range)
#Here, the fit for predicting log10(eye size) is -1.18 + log10(0.64 * Body length) + log10(0.0001 * Max depth)
```

### Thoughts on analyses so far

It looks like we are detecting effects of both depth and photophore complexity on relative eye size, which is super cool!! In terms of other models to build, since we have a low number of species for comparative methods (n = 15), I'm inclined to avoid building larger additive models for these effects, as that will greatly increase the ratio of parameter number to sample size. That's just my thought though, we could certainly try it if you want to, as well as look at alternate additive approaches like ranking models by AIC. With PGLS, you have to fix lambda across the models instead of estimating via max likelihood or else the models aren't comparable via AIC, but since the estimate of lambda is unreliable anyway here we could try repeating analyses with lambda fixed at 0 and 1 to bin the range of possible results depending how much phylogenetic signal is truly present. 

I think the best approach is to use these models to do specific hypothesis testing. We can certainly plug lots of variables into the models in various combinations and do model comparisons to find the 'best fits', but the more things we test, the more likely we are to find things that come up significant, and the more parameters we add, the more likely higher-parameter models will fit better. So, in general I'd advocate for only testing variables that you have a hypothesis for in terms of why that might affect relative eye size, or things that you see interesting patterns in when looking at the data.

I'm super excited about your data and initial results and am always happy to add plots/analyses here in R as you think of more cool things to look at!!
