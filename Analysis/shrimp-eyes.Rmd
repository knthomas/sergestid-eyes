---
title: "Eye size and allometry in deep-sea sergestids"
author: "Katie Thomas"
date: "July 2020"
output:
  html_document:
    code_fold: hide
    theme: flatly
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

<style type="text/css">

body{ /* Normal  */
      font-size: 17px;
  }
  
</style>

```{r setup, include=FALSE}

#set rmarkdown options
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 8, attr.output='style="max-height: 300px;"') 

#load libraries
library(cowplot)
library(plyr)
library(knitr)
library(kableExtra)
library(gridExtra)
library(evobiR)
library(geiger)
library(phylotools)
library(ape)
library(caper)
library(phytools)
library(smatr)
library(tidyverse)
library(plotly)
```

# Data

## Morphological data

Morphological measurements (eye diameter and body length) were taken from fresh [?] specimens. In total, 454 sergestid specimens were sampled from 15 species belonging to 11 genera and two subgroups (Sergestes and Sergia).

```{r import-data}

# Full dataset for developmental allometry ------

#import data
specimens_raw <- data.frame(read.csv("../Data/specimen_data.csv", header=TRUE, na.strings=c("", "NA", " ", stringsAsFactors = FALSE)))

#tidy data
specimens <- specimens_raw %>%
  mutate(Genus = gsub('\\s+', '', Genus)) %>%
  mutate(Family = str_to_title(Family)) %>%
  mutate(Subgroup = str_to_title(Subgroup)) %>%
  mutate(Genus = str_to_title(Genus)) %>%
  mutate(genus_species = as.factor(paste(Genus, Species, sep = "_")))
  
# Species means for evolutionary allometry ------

#import data
species_raw <- data.frame(read.csv("../Data/species_data.csv", header=TRUE, na.strings=c("", "NA", " ", stringsAsFactors = FALSE)))

#tidy data
species <- species_raw %>%
  mutate(Genus = gsub('\\s+', '', Genus)) %>%
  mutate(genus_species = as.factor(paste(Genus, Species, sep = "_"))) 

# Show sampling -----

#compile number of shrimp sampled by species
counts <-ddply(specimens, .(specimens$Subgroup, specimens$Genus, specimens$Species), nrow) 

#create table column names
names(counts) <- c("Subgroup", "Genus","Species","Sampled") 

#generate scrolling table in RMarkdown
kable(counts[ , c("Subgroup", "Genus","Species","Sampled")], caption = "Species and sampling effort for morphological data from family Sergestidae.") %>% 
                      kable_styling(full_width = F) %>% 
                      collapse_rows(columns = 1, valign = "top") %>%
                      scroll_box(height = "400px") 
```


## Molecular phylogeny

Below is the sergestid molecular phylogeny generated by Charles Golightly that we pruned to the 15 species in the dataset for comparative analyses.

```{r import-phylo, results = "hide"}

#Import phylogeny
tree_orig <- read.tree(file = "../Data/SergPhylo_IQTree.tre")

#Make copy of tree to manipulate
tree_edit <- tree_orig

#Remove locality tags from phylo tip labels 
n <- 3 #which _ to end pattern at
pat <- paste0('^([^_]+(?:_[^_]+){',n-1,'}).*') #pattern
tree_edit$tip.label <- sub(pat, '\\1', tree_edit$tip.label) #remove tags from tips

#Make list of taxa to drop (in tree but not in dataset)
drops <- setdiff(tree_edit$tip.label, as.character(species$Binomial))

#Drop unwanted tips from phylogeny
tree.pruned <- drop.tip(phy = tree_edit, tip = drops) 

#Check and reorder tree
is.rooted(tree.pruned) 
is.binary.tree(tree.pruned) 
tree <- ladderize(tree.pruned) 

#Make row names of the species the phylogeny tip labels
rownames(species) <- species$Binomial

#Reorder species data to match phylogeny order
species <-ReorderData(tree, species, taxa.names="row names")

#check that phylogeny tips and data match exactly (if they match will return "OK")
name.check(tree, species)

#make tree ultrametric
tree <- chronopl(tree, 1)
```

```{r plot-phylo, fig.height=5, fig.width=5}

#plot tree of sampled species with original tip labels
plot.phylo(tree, #phylogeny to plot
           type = "phylogram", #how to visualize phylogeny
           show.tip.label = TRUE, #whether to show tip labels/species names
           cex = 1.0, #text size
           no.margin = TRUE, 
           use.edge.length = TRUE,
           edge.width = 2, #thickness of phylogeny branches
           label.offset = 0.1) #how far away from tips to put labels
```


# Developmental eye-body allometry in Sergestidae

## Intraspecific allometry in each species

We first examine intraspecific eye diameter-body length allometry across 15 species of deep-sea sergestid shrimp. Allometric relationships were fit using standardised major axis regression via the smatr package. For each species, standard model checks, model fits, and an interactive plot of data and fits are shown. Hover over the plots to see individual data values (this is super helpful for checking weird outliers that may be typos in the source datasheets).

### _Allosergestes pectinatus_

```{r dev-apec}

# Subset data -----
apec <- specimens %>% filter(genus_species == "Allosergestes_pectinatus")

# Fit SMA model ------
sma_apec <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = apec, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_apec, which = "default",type = "o") 
plot(sma_apec, which = "residual",type = "o")
plot(sma_apec, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_apec)

#save coefficients of fits as object
cc_sma_apec <- data.frame(coef(sma_apec))

# Make plot ------
plot_apec <- ggplot(apec, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Allosergestes pectinatus") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_apec, aes(intercept = cc_sma_apec[1,1], slope = cc_sma_apec[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_apec[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_apec[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_apec)
```

### _Allosergestes sargassi_

**Note: this species has a big outlier that's worth checking in the original data**

```{r dev-asar}

# Subset data -----
asar <- specimens %>% filter(genus_species == "Allosergestes_sargassi")

# Fit SMA model ------
sma_asar <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = asar, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_asar, which = "default",type = "o") 
plot(sma_asar, which = "residual",type = "o")
plot(sma_asar, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_asar)

#save coefficients of fits as object
cc_sma_asar <- data.frame(coef(sma_asar))

# Make plot ------
plot_asar <- ggplot(asar, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Allosergestes sargassi") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_asar, aes(intercept = cc_sma_asar[1,1], slope = cc_sma_asar[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_asar[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_asar[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_asar)
```

### _Challengerosergia hansjacobi_
```{r dev-chan}

# Subset data -----
chan <- specimens %>% filter(genus_species == "Challengerosergia_hansjacobi")

# Fit SMA model ------
sma_chan <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = chan, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_chan, which = "default",type = "o") 
plot(sma_chan, which = "residual",type = "o")
plot(sma_chan, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_chan)

#save coefficients of fits as object
cc_sma_chan <- data.frame(coef(sma_chan))

# Make plot ------
plot_chan <- ggplot(chan, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Challengerosergia hansjacobi") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_chan, aes(intercept = cc_sma_chan[1,1], slope = cc_sma_chan[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_chan[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_chan[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_chan)
```

### _Challengerosergia talismani_
```{r dev-ctal}

# Subset data -----
ctal <- specimens %>% filter(genus_species == "Challengerosergia_talismani")

# Fit SMA model ------
sma_ctal <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = ctal, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_ctal, which = "default",type = "o") 
plot(sma_ctal, which = "residual",type = "o")
plot(sma_ctal, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_ctal)

#save coefficients of fits as object
cc_sma_ctal <- data.frame(coef(sma_ctal))

# Make plot ------
plot_ctal <- ggplot(ctal, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Challengerosergia talismani") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_ctal, aes(intercept = cc_sma_ctal[1,1], slope = cc_sma_ctal[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_ctal[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_ctal[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_ctal)
```

### _Deosergestes corniculum_
```{r dev-dcor}

# Subset data -----
dcor <- specimens %>% filter(genus_species == "Deosergestes_corniculum")

# Fit SMA model ------
sma_dcor <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = dcor, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_dcor, which = "default",type = "o") 
plot(sma_dcor, which = "residual",type = "o")
plot(sma_dcor, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_dcor)

#save coefficients of fits as object
cc_sma_dcor <- data.frame(coef(sma_dcor))

# Make plot ------
plot_dcor <- ggplot(dcor, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Deosergestes corniculum") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_dcor, aes(intercept = cc_sma_dcor[1,1], slope = cc_sma_dcor[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_dcor[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_dcor[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_dcor)
```

### _Deosergestes henseni_
```{r dev-dhen}

# Subset data -----
dhen <- specimens %>% filter(genus_species == "Deosergestes_henseni")

# Fit SMA model ------
sma_dhen <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = dhen, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_dhen, which = "default",type = "o") 
plot(sma_dhen, which = "residual",type = "o")
plot(sma_dhen, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_dhen)

#save coefficients of fits as object
cc_sma_dhen <- data.frame(coef(sma_dhen))

# Make plot ------
plot_dhen <- ggplot(dhen, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Deosergestes henseni") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_dhen, aes(intercept = cc_sma_dhen[1,1], slope = cc_sma_dhen[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_dhen[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_dhen[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_dhen)
```

### _Gardinerosergia splendens_
```{r dev-gspl}

# Subset data -----
gspl <- specimens %>% filter(genus_species == "Gardinerosergia_splendens")

# Fit SMA model ------
sma_gspl <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = gspl, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_gspl, which = "default",type = "o") 
plot(sma_gspl, which = "residual",type = "o")
plot(sma_gspl, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_gspl)

#save coefficients of fits as object
cc_sma_gspl <- data.frame(coef(sma_gspl))

# Make plot ------
plot_gspl <- ggplot(gspl, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Gardinerosergia splendens") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_gspl, aes(intercept = cc_sma_gspl[1,1], slope = cc_sma_gspl[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_gspl[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_gspl[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_gspl)
```

### _Neosergestes edwardsii_

**Note: there is a big outlier in this species where the eye size is actually bigger than the body length (seems impossible) - flagging to check. Also, sample size is low and narrow range of body sizes so this species will probably not make the cut for developmental allometry but is great for the evolutionary comparisons**

```{r dev-nedw}

# Subset data -----
nedw <- specimens %>% filter(genus_species == "Neosergestes_edwardsii")

# Fit SMA model ------
sma_nedw <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = nedw, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_nedw, which = "default",type = "o") 
plot(sma_nedw, which = "residual",type = "o")
plot(sma_nedw, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_nedw)

#save coefficients of fits as object
cc_sma_nedw <- data.frame(coef(sma_nedw))

# Make plot ------
plot_nedw <- ggplot(nedw, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Neosergestes edwardsii") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_nedw, aes(intercept = cc_sma_nedw[1,1], slope = cc_sma_nedw[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_nedw[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_nedw[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_nedw)
```

### _Parasergestes armatus_
```{r dev-parm}

# Subset data -----
parm <- specimens %>% filter(genus_species == "Parasergestes_armatus")

# Fit SMA model ------
sma_parm <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = parm, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_parm, which = "default",type = "o") 
plot(sma_parm, which = "residual",type = "o")
plot(sma_parm, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_parm)

#save coefficients of fits as object
cc_sma_parm <- data.frame(coef(sma_parm))

# Make plot ------
plot_parm <- ggplot(parm, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Parasergestes armatus") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_parm, aes(intercept = cc_sma_parm[1,1], slope = cc_sma_parm[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_parm[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_parm[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_parm)
```

### _Parasergestes vigilax_
```{r dev-pvig}

# Subset data -----
pvig <- specimens %>% filter(genus_species == "Parasergestes_vigilax")

# Fit SMA model ------
sma_pvig <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = pvig, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_pvig, which = "default",type = "o") 
plot(sma_pvig, which = "residual",type = "o")
plot(sma_pvig, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_pvig)

#save coefficients of fits as object
cc_sma_pvig <- data.frame(coef(sma_pvig))

# Make plot ------
plot_pvig <- ggplot(pvig, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Parasergestes vigilax") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_pvig, aes(intercept = cc_sma_pvig[1,1], slope = cc_sma_pvig[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_pvig[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_pvig[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_pvig)
```

### _Phorcosergia grandis_

**Note: there's  a pretty large outlier in this subset that merits a second look**

```{r dev-pgra}

# Subset data -----
pgra <- specimens %>% filter(genus_species == "Phorcosergia_grandis")

# Fit SMA model ------
sma_pgra <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = pgra, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_pgra, which = "default",type = "o") 
plot(sma_pgra, which = "residual",type = "o")
plot(sma_pgra, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_pgra)

#save coefficients of fits as object
cc_sma_pgra <- data.frame(coef(sma_pgra))

# Make plot ------
plot_pgra <- ggplot(pgra, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Phorcosergia grandis") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_pgra, aes(intercept = cc_sma_pgra[1,1], slope = cc_sma_pgra[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_pgra[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_pgra[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_pgra)
```

### _Robustasergia robusta_
```{r dev-rrob}

# Subset data -----
rrob <- specimens %>% filter(genus_species == "Robustasergia_robusta")

# Fit SMA model ------
sma_rrob <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = rrob, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_rrob, which = "default",type = "o") 
plot(sma_rrob, which = "residual",type = "o")
plot(sma_rrob, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_rrob)

#save coefficients of fits as object
cc_sma_rrob <- data.frame(coef(sma_rrob))

# Make plot ------
plot_rrob <- ggplot(rrob, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Robustasergia robusta") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_rrob, aes(intercept = cc_sma_rrob[1,1], slope = cc_sma_rrob[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_rrob[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_rrob[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_rrob)
```

### _Robustosergia regalis_
```{r dev-rreg}

# Subset data -----
rreg <- specimens %>% filter(genus_species == "Robustosergia_regalis")

# Fit SMA model ------
sma_rreg <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = rreg, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_rreg, which = "default",type = "o") 
plot(sma_rreg, which = "residual",type = "o")
plot(sma_rreg, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_rreg)

#save coefficients of fits as object
cc_sma_rreg <- data.frame(coef(sma_rreg))

# Make plot ------
plot_rreg <- ggplot(rreg, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Robustosergia regalis") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_rreg, aes(intercept = cc_sma_rreg[1,1], slope = cc_sma_rreg[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_rreg[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_rreg[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_rreg)
```

### _Sergestes atlanticus_
```{r dev-satl}

# Subset data -----
satl <- specimens %>% filter(genus_species == "Sergestes_atlanticus")

# Fit SMA model ------
sma_satl <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = satl, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_satl, which = "default",type = "o") 
plot(sma_satl, which = "residual",type = "o")
plot(sma_satl, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_satl)

#save coefficients of fits as object
cc_sma_satl <- data.frame(coef(sma_satl))

# Make plot ------
plot_satl <- ggplot(satl, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Sergestes atlanticus") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_satl, aes(intercept = cc_sma_satl[1,1], slope = cc_sma_satl[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_satl[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_satl[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_satl)
```

### _Sergia tenuiremis_
```{r dev-sten}

# Subset data -----
sten <- specimens %>% filter(genus_species == "Sergia_tenuiremis")

# Fit SMA model ------
sma_sten <- sma(formula = Eye_Diameter ~ Body_Length, 
            data = sten, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            alpha = 0.05)

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_sten, which = "default",type = "o") 
plot(sma_sten, which = "residual",type = "o")
plot(sma_sten, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_sten)

#save coefficients of fits as object
cc_sma_sten <- data.frame(coef(sma_sten))

# Make plot ------
plot_sten <- ggplot(sten, aes(x = Body_Length, y = Eye_Diameter)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  ggtitle("Sergia tenuiremis") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title = element_text(face = "italic")) +
  geom_abline(data = cc_sma_sten, aes(intercept = cc_sma_sten[1,1], slope = cc_sma_sten[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_sma_sten[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_sma_sten[1,1], digits = 2), sep = " "), size = 3)

ggplotly(plot_sten)
```

### Figure for developmental eye-body scaling across sergestids

```{r figure-dev, fig.width = 10, fig.height = 12, results = "hide"}

#make figure panels
fig.a <- plot_parm + theme(axis.title.x = element_blank())
fig.b <- plot_pvig + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.c <- plot_dcor + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.d <- plot_dhen + theme(axis.title.x = element_blank())
fig.e <- plot_asar + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.f <- plot_apec + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.g <- plot_chan + theme(axis.title.x = element_blank())
fig.h <- plot_ctal + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.i <- plot_pgra + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.j <- plot_sten + theme(axis.title.x = element_blank())
fig.k <- plot_rrob + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.l <- plot_rreg + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
fig.m <- plot_gspl
fig.n <- plot_satl + theme(axis.title.y = element_blank())
fig.o <- plot_nedw + theme(axis.title.y = element_blank())

# arrange panels in figure
plots <- plot_grid(fig.a, fig.b, fig.c, fig.d, fig.e, fig.f, fig.g, fig.h, fig.i, fig.j, fig.k, fig.l, fig.m, fig.n, fig.o, #list of plots to arrange in grid
           align = 'vh', #align horizontally and vertically
           axis = 'lb',
           labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I","J", "K", "L", "M", "N", "O"), #panel labels for figure
           hjust = -1, #adjustment for panel labels
           nrow = 5) #number of rows in grids

#view figure
plot_grid(plots)

#export figure
png("../Figures/dev-allometry.png", width = 10, height = 12, units = "in", res = 500)
plot_grid(plots)
dev.off()
```

The plots here are scaled to fit the data, so they all look similar but the slopes are actually quite variable and I think pretty interesting. This could be worth exploring for a chunk of the paper, and we might consider examining variation in developmental scaling slopes as a factor of phylogeny and things like whether each species exhibits ontogenetic descent. 

## Test whether species differ in developmental allometry

The smatr package also allows you to test whether groups exhibit significant differences in allometric scaling (slopes or intercepts). Below, we again use standardized major axis regression to model the scaling of eye diameter with body length across all specimens measured and test whether we see significant differences in developmental scaling across species. This is a bit redundant with above, but will provide statistical evidence of the (very big) difference in slopes among species. 

*Note: As we only have 7 specimens of _Neosergestes edwardsii_ and one is an odd outlier while the other 6 are all very similar in body length, we don't have the power to fit developmental eye-body scaling for that species. Thus, I've removed it from the specimen dataset before fitting this model. 

This test shows that sergestid species significantly differ in their allometric scaling relationships between eye diameter and body length (p < 0.0001). It also yields a table of pairwise comparisons so you can see exactly which species differ in slope and which do not. 

```{r species-smas}

#Filter/prep dataframe
specimens_sma <- specimens %>%
  filter(genus_species != "Neosergestes_edwardsii") %>% # Remove N. edwardsii from specimen data
  mutate(species_text = as.factor(paste(Genus, Species, sep = " "))) # Add labels for species 

# Model for developmental scaling across specimens grouped by species
sma_species <- sma(formula = Eye_Diameter ~ Body_Length * genus_species, 
            data = specimens_sma, 
            log = "xy", #sets both x and y variables as logged
            method="SMA", #defines SMA as model
            multcomp = TRUE, # adds pairwise comparisons between groups
            multcompmethod = "adjusted", # adjusts p-value for multiple comparisons
            alpha = 0.05) 

#plot fit, residuals, qq
par(mfrow = c(2,2)) #make plot window 2x2
plot(sma_species, which = "default",type = "o") 
plot(sma_species,which = "residual",type = "o")
plot(sma_species, which = "qq", type = "o")
par(mfrow = c(1,1)) 

#view fits
summary(sma_species)

#save coefficients of fits as object
cc_species <- data.frame(coef(sma_species))
```

This figure shows the developmental allometry of all the species with sufficient sampling (n = 14). It's interactive, so you can click on different species in the legend to hide or show those points. That can be helpful for exploring patterns in a big mess of data. To me, it looks a bit like smaller-bodied species have higher slopes? That's something we could test for if we wanted to. Here, it looks like _Sergestes atlanticus_, _Allosergestes_pectinatus_, and _Parasergestes vigilax_ have different (higher) slopes compared to the other sergestids, and the other species differ a bit in slopes but more so in intercepts. 

```{r, fig.width=9, fig.height=9}
#make shape pallette
shapes.sp <- c("Allosergestes pectinatus" = 21,
              "Allosergestes sargassi" = 22, 
              "Challengerosergia hansjacobi" = 23, 
              "Challengerosergia talismani" = 24,
              "Deosergestes corniculum" = 25 , 
              "Deosergestes henseni" = 21, 
              "Gardinerosergia splendens" = 22, 
              "Parasergestes armatus" = 23, 
              "Parasergestes vigilax" = 24, 
              "Phorcosergia grandis" = 25, 
              "Robustasergia robusta" = 21 ,
              "Robustosergia regalis" = 22,
              "Sergestes atlanticus" = 23,
              "Sergia tenuiremis" = 24)

#make color pallette
cols.sp <- c("Allosergestes pectinatus" = "#a6cee3",
              "Allosergestes sargassi" = "#1f78b4", 
              "Challengerosergia hansjacobi" = "#b2df8a", 
              "Challengerosergia talismani" = "#33a02c",
              "Deosergestes corniculum" = "#fb9a99" , 
              "Deosergestes henseni" = "#e31a1c", 
              "Gardinerosergia splendens" = "#fdbf6f", 
              "Parasergestes armatus" = "#ff7f00", 
              "Parasergestes vigilax" = "#cab2d6", 
              "Phorcosergia grandis" = "#6a3d9a", 
              "Robustasergia robusta" ="gray31" ,
              "Robustosergia regalis" = "black",
              "Sergestes atlanticus" = "maroon1",
              "Sergia tenuiremis" = "orchid1")

#set s limits by species for plots
limits <- specimens_sma %>%
  group_by(genus_species) %>%
  summarise(max = max(Body_Length, na.rm = TRUE),
            min = min(Body_Length, na.rm = TRUE))


#make plot
plot_species <- ggplot(specimens_sma, aes(x = Body_Length, y = Eye_Diameter, color =  species_text, shape = species_text, fill = species_text)) + 
  geom_point(size = 2.5, alpha = 0.7) + 
  scale_shape_manual(values = shapes.sp, name = "Species") + 
  scale_color_manual(values = cols.sp, name = "Species") +
  scale_fill_manual(values = cols.sp, name = "Species") +
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.text = element_text(face = "italic")) +
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Allosergestes_pectinatus")], xend = limits$max[which(limits$genus_species == "Allosergestes_pectinatus")], y = 10^(log10(limits$min[which(limits$genus_species == "Allosergestes_pectinatus")])*cc_species["Allosergestes_pectinatus", "slope"] + cc_species["Allosergestes_pectinatus", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Allosergestes_pectinatus")])*cc_species["Allosergestes_pectinatus", "slope"] + cc_species["Allosergestes_pectinatus", "elevation"])), color = cols.sp["Allosergestes pectinatus"]) + #Rana temporaria adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Allosergestes_sargassi")], xend = limits$max[which(limits$genus_species == "Allosergestes_sargassi")], y = 10^(log10(limits$min[which(limits$genus_species == "Allosergestes_sargassi")])*cc_species["Allosergestes_sargassi", "slope"] + cc_species["Allosergestes_sargassi", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Allosergestes_sargassi")])*cc_species["Allosergestes_sargassi", "slope"] + cc_species["Allosergestes_sargassi", "elevation"])), color = cols.sp["Allosergestes sargassi"]) + #Allosergestes_sargassi adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Challengerosergia_hansjacobi")], xend = limits$max[which(limits$genus_species == "Challengerosergia_hansjacobi")], y = 10^(log10(limits$min[which(limits$genus_species == "Challengerosergia_hansjacobi")])*cc_species["Challengerosergia_hansjacobi", "slope"] + cc_species["Challengerosergia_hansjacobi", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Challengerosergia_hansjacobi")])*cc_species["Challengerosergia_hansjacobi", "slope"] + cc_species["Challengerosergia_hansjacobi", "elevation"])), color = cols.sp["Challengerosergia hansjacobi"]) + #Challengerosergia_hansjacobi adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Challengerosergia_talismani")], xend = limits$max[which(limits$genus_species == "Challengerosergia_talismani")], y = 10^(log10(limits$min[which(limits$genus_species == "Challengerosergia_talismani")])*cc_species["Challengerosergia_talismani", "slope"] + cc_species["Challengerosergia_talismani", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Challengerosergia_talismani")])*cc_species["Challengerosergia_talismani", "slope"] + cc_species["Challengerosergia_talismani", "elevation"])), color = cols.sp["Challengerosergia talismani"]) + #Challengerosergia_talismani adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Deosergestes_corniculum")], xend = limits$max[which(limits$genus_species == "Deosergestes_corniculum")], y = 10^(log10(limits$min[which(limits$genus_species == "Deosergestes_corniculum")])*cc_species["Deosergestes_corniculum", "slope"] + cc_species["Deosergestes_corniculum", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Deosergestes_corniculum")])*cc_species["Deosergestes_corniculum", "slope"] + cc_species["Deosergestes_corniculum", "elevation"])), color = cols.sp["Deosergestes corniculum"]) + #Deosergestes_corniculum adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Deosergestes_henseni")], xend = limits$max[which(limits$genus_species == "Deosergestes_henseni")], y = 10^(log10(limits$min[which(limits$genus_species == "Deosergestes_henseni")])*cc_species["Deosergestes_henseni", "slope"] + cc_species["Deosergestes_henseni", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Deosergestes_henseni")])*cc_species["Deosergestes_henseni", "slope"] + cc_species["Deosergestes_henseni", "elevation"])), color = cols.sp["Deosergestes henseni"]) + #Deosergestes henseni adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Gardinerosergia_splendens")], xend = limits$max[which(limits$genus_species == "Gardinerosergia_splendens")], y = 10^(log10(limits$min[which(limits$genus_species == "Gardinerosergia_splendens")])*cc_species["Gardinerosergia_splendens", "slope"] + cc_species["Gardinerosergia_splendens", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Gardinerosergia_splendens")])*cc_species["Gardinerosergia_splendens", "slope"] + cc_species["Gardinerosergia_splendens", "elevation"])), color = cols.sp["Gardinerosergia splendens"]) + #Gardinerosergia splendens adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Parasergestes_armatus")], xend = limits$max[which(limits$genus_species == "Parasergestes_armatus")], y = 10^(log10(limits$min[which(limits$genus_species == "Parasergestes_armatus")])*cc_species["Parasergestes_armatus", "slope"] + cc_species["Parasergestes_armatus", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Parasergestes_armatus")])*cc_species["Parasergestes_armatus", "slope"] + cc_species["Parasergestes_armatus", "elevation"])), color = cols.sp["Parasergestes armatus"]) + #Parasergestes armatus adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Parasergestes_vigilax")], xend = limits$max[which(limits$genus_species == "Parasergestes_vigilax")], y = 10^(log10(limits$min[which(limits$genus_species == "Parasergestes_vigilax")])*cc_species["Parasergestes_vigilax", "slope"] + cc_species["Parasergestes_vigilax", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Parasergestes_vigilax")])*cc_species["Parasergestes_vigilax", "slope"] + cc_species["Parasergestes_vigilax", "elevation"])), color = cols.sp["Parasergestes vigilax"]) + #Parasergestes vigilax adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Phorcosergia_grandis")], xend = limits$max[which(limits$genus_species == "Phorcosergia_grandis")], y = 10^(log10(limits$min[which(limits$genus_species == "Phorcosergia_grandis")])*cc_species["Phorcosergia_grandis", "slope"] + cc_species["Phorcosergia_grandis", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Phorcosergia_grandis")])*cc_species["Phorcosergia_grandis", "slope"] + cc_species["Phorcosergia_grandis", "elevation"])), color = cols.sp["Hyla meridiondalis"]) + #Phorcosergia grandis adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Robustasergia_robusta")], xend = limits$max[which(limits$genus_species == "Robustasergia_robusta")], y = 10^(log10(limits$min[which(limits$genus_species == "Robustasergia_robusta")])*cc_species["Robustasergia_robusta", "slope"] + cc_species["Robustasergia_robusta", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Robustasergia_robusta")])*cc_species["Robustasergia_robusta", "slope"] + cc_species["Robustasergia_robusta", "elevation"])), color = cols.sp["Robustasergia robusta"]) + #Robustasergia robusta adult scaling
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Robustosergia_regalis")], xend = limits$max[which(limits$genus_species == "Robustosergia_regalis")], y = 10^(log10(limits$min[which(limits$genus_species == "Robustosergia_regalis")])*cc_species["Robustosergia_regalis", "slope"] + cc_species["Robustosergia_regalis", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Robustosergia_regalis")])*cc_species["Robustosergia_regalis", "slope"] + cc_species["Robustosergia_regalis", "elevation"])), color = cols.sp["Robustosergia regalis"]) +
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Sergestes_atlanticus")], xend = limits$max[which(limits$genus_species == "Sergestes_atlanticus")], y = 10^(log10(limits$min[which(limits$genus_species == "Sergestes_atlanticus")])*cc_species["Sergestes_atlanticus", "slope"] + cc_species["Sergestes_atlanticus", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Sergestes_atlanticus")])*cc_species["Sergestes_atlanticus", "slope"] + cc_species["Sergestes_atlanticus", "elevation"])), color = cols.sp["Sergestes atlanticus"]) +
  geom_segment(aes(x = limits$min[which(limits$genus_species == "Sergia_tenuiremis")], xend = limits$max[which(limits$genus_species == "Sergia_tenuiremis")], y = 10^(log10(limits$min[which(limits$genus_species == "Sergia_tenuiremis")])*cc_species["Sergia_tenuiremis", "slope"] + cc_species["Sergia_tenuiremis", "elevation"]), yend = 10^(log10(limits$max[which(limits$genus_species == "Sergia_tenuiremis")])*cc_species["Sergia_tenuiremis", "slope"] + cc_species["Sergia_tenuiremis", "elevation"])), color = cols.sp["Sergia tenuiremis"])


#interactive plot
ggplotly(plot_species)
```


```{r, results = "hide"}
#export figure
png("../Figures/dev-species.png", width = 12, height = 12, units = "in", res = 500)
plot_species
dev.off()
```


## Phylogenetic distribution of allometric slopes

Below, we plot species-specific slopes for developmental allometry onto the sergestid tree to visualize the distribution and variation of the relationships between eye and body size throughout growth. There is potential to do more with these data; do we have predictions for what might drive species differences in developmental allometry? It looks like body size might be one factor, as the smaller-bodied species seem to have higher slopes. Whether species exhibit ontogenetic descent may be another factor to explore? We might predict that species that have ontogenetic descent and are going into dimmer habitats as they grow may invest in higher eye growth relative to body growth. Do all sergestids exhibit ontogenetic descent?

```{r slope-phylo, results = "hide", fig.width=10, fig.height=7}

#Add slopes for developmental allometry into species dataframe ----

#add coefficient rownames to genus_species column
cc_species$genus_species <- rownames(cc_species)

#merge coefficients with species data by rowname
species_sma <- left_join(species, cc_species, by = "genus_species") %>%
  filter(genus_species != "Neosergestes_edwardsii")

# Prep data and phylogeny -----

#Make list of taxa to drop (in tree but not in dataset)
drops <- setdiff(tree$tip.label, as.character(species_sma$Binomial))

#Drop unwanted tips from phylogeny
tree.dev <- drop.tip(phy = tree, tip = drops) 

# Make Genus_species tip labels to replace Binomial codes
sp.tips <- data.frame(old = species_sma$Binomial, new = species_sma$genus_species)

# replace tip labels in phylogeny
tree.dev.plot <- sub.taxa.label(tree.dev, sp.tips)

#change row names of species data
rownames(species_sma) <- species_sma$genus_species

#check that phylogeny and data match exactly
name.check(tree.dev.plot, species_sma)

#resort trait dataset to the order of tree tip labels
species_sma <- species_sma[tree.dev.plot$tip.label, ] 

#make trait vector for slope
slope <- as.vector(species_sma$slope) 

#add tip label names to vector
names(slope) <- species_sma$genus_species

# Phylogeny with slopes for developmental eye-body allometry----
plotTree.wBars(tree.dev.plot, slope, 
               scale = 0.5, 
               tip.labels = TRUE,
               offset = 0.1,
               ftype = "bi",
               fsize = 1)

#export figure
png("../Figures/dev-phylo.png", width = 10, height = 7, units = "in", res = 500)

plotTree.wBars(tree.dev.plot, slope, 
               scale = 0.5, 
               tip.labels = TRUE,
               offset = 0.1,
               ftype = "bi",
               fsize = 1)

dev.off()
```

# Evolutionary eye-body allometry in Sergestidae

We next examine interspecific eye-body allometry across sergestids using species means for eye diameter and body length. Here, we use phylogenetic least-squares regression (using the caper package) to fit the allometric relationship between eye size and body length across 15 species of sergestids.

*Flagging to discuss calculation of species means with Lori*

```{r evo-pgls, results = "hide"}

# Prep data ------

#check that names match in dataframe and tree
name.check(phy = tree, data = species, data.names = species$Binomial)
  
#set node names to null (or throws duplicate error)
tree$node.label <- NULL

#use caper function to combine phylogeny and data into one object (this function also matches species names in tree and dataset)
species.comp <- comparative.data(phy = tree, data = species, 
                            names.col = Binomial, vcv = TRUE, 
                            na.omit = FALSE, warn.dropped = TRUE)

#check for dropped tips or dropped species
species.comp$dropped$tips #phylogeny
species.comp$dropped$unmatched.rows #dataset

# PGLS model -------

#fit model
pgls_evo <- pgls(log10(Eye_diameter) ~ log10(Body_length), 
               data = species.comp, 
               lambda = "ML", #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#check model assumptions
par(mar = c(4,4,2,2))
par(mfrow = c(2, 2))
plot(pgls_evo)
par(mfrow = c(1, 1))
```

The PGLS regression shows that eyes scale with body length with a slope of 0.85, indicating that eyes have a negative/hypo allometry with body size. This is what is most common among all vertebrates and some invertebrates that have been examined so far (inverts tend to vary a lot more than verts). 

The maximum likelihood estimate of lambda here is 1.00 (high phylogenetic signal), so that's what caper has used to create the variance-covariance matrix for the regression. However, small sample sizes (< 20-30 data points) have no power to estimate lambda (see Freckleton et al. 2002), so tests for phylogenetic signal in this dataset are essentially meaningless (note that the 95% confidence interval for lambda here is 0 to 1, all possible values, and the p-values are non-signficant). For this reason, if any of our other comparative analyses estimate a lambda of 0, we should repeat them again forcing lambda to 1, just so we can see what difference that makes in the model fits (as we can't know what lambda actually is in this small dataset). Alternatively, we could run all fits with lambda set to 0 (which ignores phylogeney) and again to 1 (highest phylogenetic signal) so that we can bin the possible results into the extremes. 

```{r}
#print model output 
summary(pgls_evo)

#Likelihood plot for Pagel's lambda 
lambda.evo <- pgls.profile(pgls_evo, "lambda")
plot(lambda.evo, main = "Pagel's lambda", 
     sub = "Solid red line indicates estimate for lambda and broken red lines indcaite the 95% confidence interval")

#save coefficients of fits as object
cc_pgls_evo <- data.frame(coef(pgls_evo))

# Make plot ------
plot_evo <- ggplot(species, aes(x = Body_length, y = Eye_diameter, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_x_log10(name = "Body length (mm)") + #makes x axis log scale and named
  scale_y_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  geom_abline(data = cc_pgls_evo, aes(intercept = cc_pgls_evo[1,1], slope = cc_pgls_evo[2,1])) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 1.5, nudge_x = 4, label = paste("slope =", round(cc_pgls_evo[2,1], digits = 2), sep = " "), size = 3) +
  geom_text(x = -Inf, y = Inf, hjust = -0.05, vjust = 3, label = paste("intercept =", round(cc_pgls_evo[1,1], digits = 2), sep = " "), size = 3)

#interactive plot
ggplotly(plot_evo)

# Export figure -----

```


# Correlates of eye size in deep-sea sergestid shrimp

Next, we examine whether varition in relative eye size is correlated with ecological variables related to light regime and vision: depth range and bioluminescent organs. 

## Ecology and absolute and relative eye size across species

Here, we examine how absolute and relative eye size vary across the sergestid phylogeny, and whether these correlate to ecological variables. For visualizing relative eye size, we use the residuals of the PGLS fit for eye-body allometry, as these show eye size corrected by both body size and evolutionary relationships.  

*There are few enough species that it would be really nice to put an image of each species next to the phylogeny/associated data if you have them. If not photos, we could make vector images of species sillhouettes and scale them by body size for easy reference*. 

```{r eyesize-eco, results = "hide", fig.width=8, fig.height=5.5, fig.cap = "Phylogeny of the 15 sertestids sampled depicting absolute eye diameter (purple circles scaled by absolute size), relative eye investment (bars scaled by the residuals from the PGLS of eye diameter vs. body length), and photophore complexity (colored boxes)."}

#Add residuals from PGLS fits to dataframe ----

#extract pgls residuals 
pglsres <- residuals(pgls_evo) 

#name residuals
colnames(pglsres) <- "pglsres" 

#merge residuals with species data by rowname
species.phy <- merge(species, pglsres, by = "row.names") 

#make column converted to observed eye size as factor of PGLS fit
species.phy$eyefactor <- 10^species.phy$pglsres

# Prep data and phylogeny -----

# Make Genus_species tip labels to replace Binomial codes
sp.tips <- data.frame(old = species.phy$Binomial, new = species.phy$genus_species)

# replace tip labels in phylogeny
tree.plot <- sub.taxa.label(tree, sp.tips)

#change row names of species data
rownames(species.phy) <- species.phy$genus_species

#check that phylogeny and data match exactly
name.check(tree.plot, species.phy)

#resort trait dataset to the order of tree tip labels
species.phy <- species.phy[tree.plot$tip.label, ] 

#make trait vector for absolute eye size
aveye <- as.vector(species.phy$Eye_diameter) 

#add tip label names to vector
names(aveye) <- species.phy$genus_species

#make trait vector for eye investment (PGLS residuals)
releye <- as.vector(species.phy$pglsres) #residuals of pgls
names(releye) <- species.phy$genus_species


# Phylogeny with eye size and investment -------

#color vector for photophores
col_ph <- c("lensed" = "palegreen",
            "none" = "honeydew",
            "pesta" = "cadetblue1",
            "unlensed" = "orchid1")

#plot tree with eye investment bars
plotTree.wBars(tree.plot, releye, 
               scale = 4, 
               tip.labels = TRUE,
               offset = 0.8,
               ftype = "bi",
               fsize = 1.2)

#add tip labels for absolute eye size
tiplabels(cex = 1.5*aveye,
          pch = 19, #shape of labels
          col = "mediumpurple",
          offset = 0) 

#add tip labels for eye size
tiplabels(text = species.phy$Organ,
          cex = 0.7,
          #frame = "none",
          bg = col_ph[species.phy$Organ],
          adj = 0,
          offset = 2) 

#Export figure------
png("../Figures/phylo.png", width = 8, height = 5.5, units = "in", res = 500)

#plot tree with eye investment bars
plotTree.wBars(tree.plot, releye, 
               scale = 4, 
               tip.labels = TRUE,
               offset = 0.8,
               ftype = "bi",
               fsize = 1.2)

#add tip labels for absolute eye size
tiplabels(cex = 1.5*aveye,
          pch = 19, #shape of labels
          col = "mediumpurple",
          offset = 0) 

#add tip labels for eye size
tiplabels(text = species.phy$Organ,
          cex = 0.7,
          #frame = "none",
          bg = col_ph[species.phy$Organ],
          adj = 0,
          offset = 2) 

dev.off()
```

## Visualizing eye size and ecology 

The following are exploratory plots that do not account for the phylogenetic distribution of traits. Plots are interactive: hover over a data point to see the species and x/y values.  

### Photophore complexity 

**Prediction:** We might predict that species that have highly developed photophrores may be more likely to engage in visual signaling, and thus may have higher investments in eye size. However, this is the opposite of what we see here (species with organs of pesta have the smallest eyes and the lowest relative investment in eye size). As BL can also be used for camouflage, and BL from other species is ubiquitous, there is a reasonable expectation that they could be uncorrelated as well.

```{r photo-viz}

#Boxplots for absolute eye size across photophores -----
plot_abs_photo <- ggplot(data = species.phy, aes(x = reorder(Organ, Eye_diameter, FUN = mean), y = Eye_diameter)) + 
  geom_boxplot(notch = FALSE, outlier.shape = NA, alpha = 0.6) + #controls boxes
  stat_summary(fun.y = mean, colour = "black", geom = "point", shape = 18, size = 3, show_guide = FALSE) + #controls what stats shown
 geom_jitter(shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) + #controls background
  xlab("Photophore complexity") +
  ylab("Eye diameter (mm)") +
  ggtitle("Absolute eye size")

ggplotly(plot_abs_photo)

#Boxplots for relative eye investment across photophores -----
plot_rel_photo <- ggplot(data = species.phy, aes(x = reorder(Organ, pglsres, FUN = mean), y = pglsres)) + 
  geom_boxplot(notch = FALSE, outlier.shape = NA, alpha = 0.6) + #controls boxes
  stat_summary(fun.y = mean, colour = "black", geom = "point", shape = 18, size = 3, show_guide = FALSE) + #controls what stats shown
 geom_jitter(shape = 19, size = 1.3, alpha = 0.5, position = position_jitter(0.15)) +
  theme(text = element_text(size=14), panel.background = element_blank(), axis.line = element_line(colour = "black")) + #controls background
  xlab("Photophore complexity") +
  ylab("Relative eye investment") +
  ggtitle("Relative eye investment")

ggplotly(plot_rel_photo) 


```

### Maximum depth

**Prediction:** We might expect that eye size would increase with maximum depth to some point, then may level off and become uncorrelated once the pelagic zone occupied lacks downwelling light for vision. Maximum recorded depth isn't the best indicator of where an animal actually spends its time, so we could expect that the actual depth occupied at the brightest time of day could be somewhere a bit shallower than these values, so tough to say whether and where leveling off might occur. 

Visual inspection of the data shows that absolute eye size does seem to increase with maximum depth. However, body size also increases with maximum depth, and both relative eye size (eye/body) and eye investment (residuals of PGLS for eye ~ body) show litte to no correlation with maximum depth. 

```{r depth-viz}

# Absolute eye size by max depth ------
plot_abs_max <- ggplot(species.phy, aes(x = Eye_diameter, y = Max_depth, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_abs_max)

# Body size with max depth -----
plot_body_max <- ggplot(species.phy, aes(x = Body_length, y = Max_depth, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Body length (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_body_max)

# Eye size/body size with max depth -----
plot_eb_max <- ggplot(species.phy, aes(x = Relative_size, y = Max_depth, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye:body") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_eb_max)

# Relative eye investment by max depth -----
plot_inv_max <- ggplot(species.phy, aes(x = eyefactor, y = Max_depth, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Maximum depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Relative eye investment") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_inv_max)

# Absolute eye size by depth range -----
plot_abs_range <- ggplot(species.phy, aes(x = Eye_diameter, y = Depth_range, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Depth range (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_abs_range)

# Relative eye investment by depth range -----
plot_inv_range <- ggplot(species.phy, aes(x = eyefactor, y = Depth_range, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Depth range (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Relative eye investment") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_inv_range)


# Absolute eye size by mid depth -----

#add column for midpoint of depth range
species.phy <- species.phy %>%
  mutate(depth_mid = ((Max_depth - Min_depth)/2) + Min_depth)

#plot
plot_abs_mid <- ggplot(species.phy, aes(x = Eye_diameter, y = depth_mid, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Midpoint depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Eye diameter (mm)") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_abs_mid)

# Relative eye investment by mid depth -----
plot_inv_mid <- ggplot(species.phy, aes(x = eyefactor, y = depth_mid, text = genus_species)) + 
  geom_point(size = 2, alpha = 0.6) + 
  scale_y_reverse(name = "Midpoint depth (m)") + #makes x axis log scale and named
  scale_x_log10(name = "Relative eye investment") + #makes y axis log scale and named
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplotly(plot_inv_mid)

```


## Comparative models

### Eye diameter ~ body length * photophore complexity

Below, I run a PGLS model of log10(eye diameter) vs. log10(body length) with photophore complexity as a covariate (= phylogenetic ANCOVA). Because we have so many states for photophore complexity and a small sample of species, we cannot look at the interaction term for body size x photophore complexity because then our states outnumber our number of observations.

```{r pgls-photo}

#run PGLS modelusing the Maximum Liklihood estimate of lambda
pgls_photo <- pgls(log10(Eye_diameter) ~ log10(Body_length) + Organ, 
               data = species.comp, 
               lambda = "ML",
               #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#evaluate model assumptions
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(pgls_photo) #plot the linear model
par(mfrow = c(1,1)) #set plotting window back to one plot
```

#### Model outputs

This output from anova(model) gives the overall significance of the main, 2-way, 3-way, etc. interactions and sequential sums of squares. Here we can see that body length has a significant effect on eye size (expected, and we already knew that), but we also find that photophore complexity has a significant effect on eye size when the effect of body size is accounted for (p = 0.01).

```{r}
#anova
anova(pgls_photo)
```

This output from summary(model) gives PGLS coefficients as well significance with respect to contrasts. Note that for a categorical variable, R will treat whichever factor comes first as the "control" and will test other factors for significant differences relative to that "control". Here, the comparison state ("control") for photophore complexity is set to "unlensed" (estimate listed under (Intercept) - that's why you don't see that state as a comparison line) and the other states show the *difference* in the estimated intercept for that state compared to the unlensed state, and whether that difference is significant. You can see that "none" and "lensed" show no significant difference in intercept from "unlensed", but that "pesta" does show a significant difference (p = 0.01) and has a lower intercept, indicating smaller relative eye size. 

The output also includes the maximum-likelihood estimation of lambda, which represents the phylogenetic signal for PGLS model *residuals*. Here, the estimate for lambda is 0.00, which means that there is no phylogenetic signal. This doesn't mean we shouldn't include phylogeny in the model (no reason not to), but it does mean that it's the same result we would get if we assessed this without including phylogeny. This also doesn't mean that there is not phylogenetic signal in the individual traits that we put into the model; this is only lambda for the *model residuals*, not the traits themselves.

```{r}
#summary
summary(pgls_photo)
```


### Eye diameter ~ body length + maximum depth

Below, I run a PGLS model of klg10(eye diameter) vs. log10(body length) with maximum depth as a covariate. This model does not test for the interaction between body length and maximum depth. 

**Question to consider:** Should we log maximum depth in these analyses? Allometric data are typically logged and I have done so throughout these analyses. Depth you could argue either way, but since light attenuates exponentially with depth and we are thinking about light environment here I'd be inclined to log? Currently, eye size and body size are logged and depth is unlogged in the below analysis. 

```{r pgls-depth}

#run PGLS modelusing the Maximum Liklihood estimate of lambda
pgls_depth <- pgls(log10(Eye_diameter) ~ log10(Body_length) + Max_depth, 
               data = species.comp, 
               lambda = "ML", bounds = list(lambda = c(1e-05, 1)),
               #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#evaluate model assumptions
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(pgls_depth) #plot the linear model
par(mfrow = c(1,1)) #set plotting window back to one plot
```

#### Model outputs

This output from anova(model) gives the overall significance of the main effects and sequential sums of squares. Here we can see that body length has a significant effect on eye size when depth is corrected for (expected, and we already knew that), but that maximum depth also has a significant effect on eye size corrected for the effects of body size (p < 0.05).

Note: I originally ran this model with an additional interaction term for depth x body length, and there was not a significant effect for maximum depth (p = 0.05) or the interaction between max depth and body length (p = 0.67). Note though that depth was very close to being significant, so this may result from our low species sample size (n = 15) combined with additional model paramaterization yielding less statistical power; additional species sampling may yield a different result. 

Second note: There is a postitive relationship between body size and maximum depth in these data (body length increases with maximum depth). This raises some concern about multicolinearity, as these models assume that our two predictive variables are independent of each other (and in this case, that is at least partially false). The finding that species mean body size increases with maximum depth could be a potentially interesting thing to have a look at as well, there are a number of studies looking at body size with depth in the deep ocean so it's definitely of interest, I think especially people thinking about carbon/food availability. 

```{r}
#anova
anova(pgls_depth)
```

This output from summary(model) gives PGLS coefficients as well significance with respect to contrasts. 

The output also gives a maximum-likelihood estimation of lambda = 0.00, indicating that there is no phylogenetic signal in the residuals of the model (and that caper used a lambda of 0 to set the variance-covariance matrix in the regression). However, small sample sizes have no power to estimate the true value of lambda, so this is not very meaningful in this dataset. We should decide on a strategy for analysis (as mentioned above, may want to run all models again with lambda fixed at 1 as a comparison for the supp info).

```{r}
#summary
summary(pgls_depth)
#Here, the fit for predicting log10(eye size) is -1.18 + log10(0.64 * Body length) + log10(0.0001 * Max depth)
```

### Eye diameter ~ body length * depth range

Below, I run a PGLS model of log10(eye diameter) vs. log10(body length) with depth range as a covariate. This model does not test for the interaction between body length and depth range. 

```{r pgls-range}

#run PGLS modelusing the Maximum Liklihood estimate of lambda
pgls_range <- pgls(log10(Eye_diameter) ~ log10(Body_length) + Depth_range, 
               data = species.comp, 
               lambda = "ML", bounds = list(lambda = c(1e-05, 1)),
               #uses Maximum Liklihood estimate of lambda
               param.CI = 0.95)

#evaluate model assumptions
par(mfrow = c(2,2)) #makes your plot window into 2x2 panels
plot(pgls_range) #plot the linear model
par(mfrow = c(1,1)) #set plotting window back to one plot
```

#### Model outputs

This output from anova(model) gives the overall significance of the main effects and sequential sums of squares. Both body length (as expected) and depth range (p < 0.05) show significant effects on eye size. 

```{r}
#anova
anova(pgls_range)
```

This output from summary(model) gives PGLS coefficients as well significance with respect to contrasts. 

The output also gives a maximum-likelihood estimation of lambda = 0.00, indicating that there is no phylogenetic signal in the residuals of the model (and that caper used a lambda of 0 to set the variance-covariance matrix in the regression). However, small sample sizes have no power to estimate the true value of lambda, so this is not very meaningful in this dataset. We should decide on a strategy for analysis (as mentioned above, may want to run all models again with lambda fixed at 1 as a comparison for the supp info).

You can see below that the coefficients are really similar to those for max depth. I think that's because in many cases depth range = max depth (min depth only varies between 0 and 300 m). They are both probably showing pretty much the same thing here. 

```{r}
#summary
summary(pgls_range)
#Here, the fit for predicting log10(eye size) is -1.18 + log10(0.64 * Body length) + log10(0.0001 * Max depth)
```

### Thoughts on analyses so far

It looks like we are detecting effects of both depth and photophore complexity on relative eye size, which is super cool!! In terms of other models to build, since we have a low number of species for comparative methods (n = 15), I'm inclined to avoid building larger additive models for these effects, as that will greatly increase the ratio of parameter number to sample size. That's just my thought though, we could certainly try it if you want to, as well as look at alternate additive approaches like ranking models by AIC. With PGLS, you have to fix lambda across the models instead of estimating via max likelihood or else the models aren't comparable via AIC, but since the estimate of lambda is unreliable anyway here we could try repeating analyses with lambda fixed at 0 and 1 to bin the range of possible results depending how much phylogenetic signal is truly present. 

I think the best approach is to use these models to do specific hypothesis testing. We can certainly plug lots of variables into the models in various combinations and do model comparisons to find the 'best fits', but the more things we test, the more likely we are to find things that come up significant, and the more parameters we add, the more likely higher-parameter models will fit better. So, in general I'd advocate for only testing variables that you have a hypothesis for in terms of why that might affect relative eye size, or things that you see interesting patterns in when looking at the data.

I'm super excited about your data and initial results and am always happy to add plots/analyses here in R as you think of more cool things to look at!!
